---
title: "Resource Quality Experiment Analysis"
author: "Michelle Fearon"
date: "5/3/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require("knitr")
opts_knit$set(root.dir = "C:/Users/mlfearon/OneDrive - Umich/PROJECTS/MHMP Daphnia Duffy/Resource Quality/Data and Code/resource-quality-expt")
getwd()
```

## Background

This code provides the compilation, analyses, and figures for the Resource Quality Experiment. The goal of this experiment was to understand how resource quality can mechanistically alter parasite prevalence by impacting host physiology.

### Question: Does resource quality directly influence parasite prevalence by altering host susceptibility via nutrition and/or immunity (host physiology)?

### Hypotheses: 
1. Hosts provided high quality food will have higher feeding rates which will lead to large body size and greater exposure to parasites (higher prevalence), and greater production of spores for both parasites.

2. Hosts provided poor quality diets will be protected from infection, potentially through a reduced feeding rate that reduces the chances of exposure, but those that do get infected will produce fewer spores per animal due to limited resources for the parasite to exploit.


### Experiment Design

- 4 Food quality: 100% Scenedesmus (high quality), 50:50 Scenedesmus:Microcystis, 100% Microcystis alone (low quality), Microcystis+Microcystin (spiked)
- 2 Host clones: Standard, Mid37
- 3 Parasite: Uninfected, Metsch, Pasteuria


Note: The comparison between the Microcystis alone and Microcystis+Microcystin (spiked) treatments will allow for testing specifically how the toxin changes host physiology and infection.

Pasteuria and Metsch (and their associated Uninfected Control treatments) with both host genotypes were run separately, therefore the data will be analyzed separately based on each of the two experiments.


```{r, set directory and load libraries, results='hide', warning=FALSE, message=FALSE}

library(dplyr)
library(tidyr)
library(lme4)
library(lmerTest)
library(glmmTMB)
library(emmeans)
library(ggeffects)
library(epiR)
library(car)
library(lubridate)
library(survival)
library(rms)
library(survminer)
library(ggplot2)
library(viridis)
library(olsrr)
library(DHARMa)
library(RColorBrewer)
```

Import Data
```{r, import data, echo=FALSE}
library(here)

# set the path to the script relative to the project root directory
here::i_am("scripts/ResourceQuality_Analysis.Rmd")
setwd("C:/Users/mlfearon/OneDrive - Umich/PROJECTS/MHMP Daphnia Duffy/Resource Quality/Data and Code/resource-quality-expt")
# Pasteuria data
p_data <- read.csv(here("data/ResourceQuality_Pasteuria_Full.csv"), stringsAsFactors = F)
p_longdata <- read.csv(here("data/ResourceQuality_Pasteuria_Full_ByExptWeek.csv"), stringsAsFactors = F)
p_lifetable <- read.csv(here("data/ResourceQuality_Pasteuria_LifeTableResults.csv"), stringsAsFactors = F)

# Metsch data
m_data <- read.csv(here("data/ResourceQuality_Metsch_Full.csv"), stringsAsFactors = F)
m_longdata <- read.csv(here("data/ResourceQuality_Metsch_Full_ByExptWeek.csv"), stringsAsFactors = F)
m_lifetable <- read.csv(here("data/ResourceQuality_Metsch_LifeTableResults.csv"), stringsAsFactors = F)

```

Reorder factors
```{r, reorder factors}
p_data$Diet <- factor(p_data$Diet, levels = c("S", "SM", "M", "M+"))
p_data$Infection <- factor(p_data$Infection, levels = c("Uninfected", "Exposed", "Infected"))
p_data$Parasites <- factor(p_data$Parasites, levels = c("Uninfected", "Pasteuria"))
p_longdata$Diet <- factor(p_longdata$Diet, levels = c("S", "SM", "M", "M+"))
p_longdata$Infection <- factor(p_longdata$Infection, levels = c("Uninfected", "Exposed", "Infected"))
p_lifetable$Diet <- factor(p_lifetable$Diet, levels = c("S", "SM", "M", "M+"))
p_lifetable$Infection <- factor(p_lifetable$Infection, levels = c("Uninfected", "Exposed", "Infected"))


m_data$Diet <- factor(m_data$Diet, levels = c("S", "SM", "M", "M+"))
m_data$Infection <- factor(m_data$Infection, levels = c("Uninfected", "Exposed", "Infected"))
m_data$Parasites <- factor(m_data$Parasites, levels = c("Uninfected", "Metsch"))
m_longdata$Diet <- factor(m_longdata$Diet, levels = c("S", "SM", "M", "M+"))
m_longdata$Infection <- factor(m_longdata$Infection, levels = c("Uninfected", "Exposed", "Infected"))
m_lifetable$Diet <- factor(m_lifetable$Diet, levels = c("S", "SM", "M", "M+"))
m_lifetable$Infection <- factor(m_lifetable$Infection, levels = c("Uninfected", "Exposed", "Infected"))

```



```{r, overdispersion function, echo=FALSE}
# Overdispersion parameter estimation function from Ben Bolker: http://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#testing-for-overdispersioncomputing-overdispersion-factor
# Comment additions from http://ase.tufts.edu/gsc/gradresources/guidetomixedmodelsinr/mixed%20model%20guide.html
overdisp_fun <- function(model) {
  rdf <- df.residual(model)
  rp <- residuals(model,type="pearson")
  Pearson.chisq <- sum(rp^2)
  prat <- Pearson.chisq/rdf
  pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
  c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}
```



## Infection Prevalence

### Comparison of Pasteuria infection prevalence based on diet and host clone.

```{r, model of Pasteuria prevalence by treatments}
p_data_prev <- p_data %>% filter(!is.na(InfectionStatus) & Parasites == "Pasteuria") # remove animals that died during exposure and remove uninfected treatments

pprevmod <- glm(InfectionStatus ~ Diet * Clone, family = binomial, data = p_data_prev)
# Note: left off the block random effect here since it seemed to cause a problem with the model... 
summary(pprevmod)
Anova(pprevmod)
overdisp_fun(pprevmod)
testDispersion(pprevmod)
testZeroInflation(pprevmod)
pprev_simResid <- simulateResiduals(fittedModel = pprevmod)
plot(pprev_simResid)  # model looks good

pprevmod_contrasts <- emmeans(pprevmod, specs = pairwise ~ Diet | Clone, type = "response")
pprevmod_contrasts

```



```{r, figure of Pasteuria prevalence by treatment}
# Marginal effects from best model with Abundance on the x axis
past_prev <- ggpredict(pprevmod, c("Clone", "Diet"))

# set the color scheme for the Diet treatments
diet_colors <- c("#ADDD8E", "#41AB5D", "#006837", "#1D91C0")

p_prev_fig <- plot(past_prev, dodge = 0.4) +
  scale_color_manual(values = diet_colors) +
  ggtitle("Pasteuria prevalence by diet x host clone") +
  labs(x = "Host Clone", y = "Pasteuria Prevalence (%)") +
  theme_classic()
p_prev_fig

# figures for presentation
p_prev_fig2 <- plot(past_prev, dodge = 0.5, show.title = F) +
  scale_color_manual(values = diet_colors) +
  #ggtitle("Pasteuria prevalence by diet x host clone") +
  labs(x = "Host Clone", y = "Bacteria Prevalence (%)") +
  theme_classic() +
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_prev_fig2

ggsave(here("figures/PasteuriaPrev_DietxClone.tiff"), plot = p_prev_fig2, dpi = 600, width = 4, height = 3, units = "in", compression="lzw")




# calculate prevalence for each diet and clone
p_data_prev$Rep <- as.character(p_data_prev$Rep)

past_prev_sum <- p_data_prev %>%
  group_by(Diet, Clone) %>%
  summarise(Infected = sum(InfectionStatus), Tested = length(Rep), 
            N  = length(Clearance_rel.Week1), 
            Mean_Clearance_rel = mean(Clearance_rel.Week1, na.rm = T),
            clearance.rel.sd   = sd(Clearance_rel.Week1, na.rm = T),
            clearance.rel.se   = clearance.rel.sd / sqrt(N), 
            .groups = "rowwise") %>%
  mutate(Prevalence = unlist(epi.prev(Infected, Tested, method = "blaker", conf.level = 0.95, sp = 1, se = 0.95))[1],
         Prev_Lower = unlist(epi.prev(Infected, Tested, method = "blaker", conf.level = 0.95, sp = 1, se = 0.95))[2],
         Prev_Upper = unlist(epi.prev(Infected, Tested, method = "blaker", conf.level = 0.95, sp = 1, se = 0.95))[3])


p_prev_fig3 <- ggplot(past_prev_sum, aes(x = Clone, y= Prevalence)) +
  geom_point(aes(color = Diet), size = 2, position = position_dodge(width = 0.7)) +
  geom_errorbar(aes(ymin = Prev_Lower, ymax = Prev_Upper, color = Diet), width = 0.2, position = position_dodge(width = 0.7)) + 
  scale_color_manual(values = diet_colors) +
  labs(x = "Host Clone", y = "Bacteria Prevalence (%)") +
  ylim(0, 100) +
  theme_classic() +
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_prev_fig3

# figures for presentation (calcuated prevalence)
p_prev_fig3 <- ggplot(past_prev_sum, aes(x = Diet, y= Prevalence)) +
  geom_point(aes(color = Diet), size = 2) +
  geom_errorbar(aes(ymin = Prev_Lower, ymax = Prev_Upper, color = Diet), width = 0.2) + 
  scale_color_manual(values = diet_colors) +
  labs(x = "Diet Treatment", y = "Bacteria Prevalence (%)") +
  ylim(0, 100) +
  facet_wrap(~Clone) +
  theme_classic() +
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_prev_fig3
ggsave(here("figures/PasteuriaPrevCalcualtions_DietxClone.tiff"), plot = p_prev_fig3, dpi = 600, width = 4, height = 3, units = "in", compression="lzw")



p_prev_feed_model <- glmer(Prevalence/100 ~ Mean_Clearance_rel * Clone + (1|Diet), weights = Tested, family = "binomial", data = past_prev_sum)
summary(p_prev_feed_model)
Anova(p_prev_feed_model)
library(rsq)
rsq(p_prev_feed_model)


p_prev_feed_fig <- ggplot(past_prev_sum, aes(x = Mean_Clearance_rel, y= Prevalence)) +
  geom_point(aes(color = Diet, shape = Clone), size = 2) +
  geom_errorbar(aes(ymin = Prev_Lower, ymax = Prev_Upper, color = Diet), width = 0.01) + 
  geom_errorbarh(aes(xmin = Mean_Clearance_rel-clearance.rel.se, xmax = Mean_Clearance_rel+clearance.rel.se, color = Diet), width = 0.01) + 
  geom_smooth(method = "lm", color = "black") +
  scale_color_manual(values = diet_colors) +
  labs(x = "Mean Relative Feeding Rate (mL per hr per mm)", y = "Bacteria Prevalence (%)") +
  ylim(-20, 100) +
  facet_wrap(~Clone) +
  theme_classic() +
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_prev_feed_fig
ggsave(here("figures/PasteuriaPrevCalcualtions_RelFeedingRate2.tiff"), plot = p_prev_feed_fig, dpi = 600, width = 4, height = 3, units = "in", compression="lzw")


```

There is a significant difference in prevalence based on clone, but not based on diet nor the interaction between the two. Standards were generally more resistant to this strain of Pasteuria compared to Mid37s. For Mid37s, there is lower Pasteuria prevalence for the M and M+ treatments, but it is not a significant difference. Maybe since we only have the 10 reps, our prevalence has rather large error bars. 

In comparison with Kristel's 2019 Proc B paper, we had lower Pasteuria infection in the mid37s overall, but also may have a greater difference between the Scenedesmus diet and the Microcystis and spiked Microcystis diets (note that we use different stains of Microcystis though).




### Comparison of Metsch infection prevalence based on diet, and host clone.

```{r, model of Metsch prevalence by treatments}
m_data_prev <- m_data %>% filter(!is.na(InfectionStatus) & Parasites == "Metsch") # remove animals that died during exposure and remove uninfected treatments

m_data_prev$Block <- as.factor(m_data_prev$Block)

mprevmod <- glmer(InfectionStatus ~ Diet * Clone + (1|Block), family = binomial, data = m_data_prev)
# Note: left off the block random effect here since it seemed to cause a problem with the model... 
summary(mprevmod)
Anova(mprevmod)
overdisp_fun(mprevmod)
AIC(mprevmod)
testDispersion(mprevmod)
testZeroInflation(mprevmod)
mprev_simResid <- simulateResiduals(fittedModel = mprevmod)
plot(mprev_simResid)  # model looks good

mprevmod_contrasts <- emmeans(mprevmod, specs = pairwise ~ Diet | Clone, type = "response")
mprevmod_contrasts

mprevmod_contrasts2 <- emmeans(mprevmod, specs = pairwise ~ Clone | Diet, type = "response")
mprevmod_contrasts2

## USE THIS MODEL
# test a model with only S and SM diets for Mid37 to remove treatments with no infection (except Std M+ did have a little infection)
m_data_prev_std <- filter(m_data_prev, Clone == "Standard")
m_data_prev_midS_SM <- filter(m_data_prev, Clone == "Mid37", Diet != "M", Diet != "M+")
m_data_prev2 <- rbind(m_data_prev_midS_SM, m_data_prev_std)

mprevmod2 <- glmer(InfectionStatus ~ Diet + Clone + (1|Block), family = binomial, data = m_data_prev2)
summary(mprevmod2)  # block random effect does work in this model, warnings because there are NAs for some groups when the interaction is present(the M and M+ treatments for Mid37s that I took out). Since the interaction is not sig, I removed it and this model looks much better with lower Std error values. --> USE THIS MODEL
Anova(mprevmod2)
overdisp_fun(mprevmod2)
AIC(mprevmod2)
testDispersion(mprevmod2)
testZeroInflation(mprevmod2)
mprev2_simResid <- simulateResiduals(fittedModel = mprevmod2)
plot(mprev2_simResid)  # model looks good

mprevmod_contrasts3 <- emmeans(mprevmod2, specs = pairwise ~ Diet | Clone, type = "response")
mprevmod_contrasts3



```

```{r, figure of Metsch prevalence by treatment}
# Marginal effects from best model with Abundance on the x axis
metsch_prev <- ggpredict(mprevmod2, c("Clone", "Diet"))

m_prev_fig <- plot(metsch_prev, dodge = 0.4) +
  scale_color_manual(values = diet_colors) +
  ggtitle("Metsch prevalence by diet x host clone") +
  labs(x = "Host Clone", y = "Metchnikowia Prevalence (%)") +
  theme_classic()
m_prev_fig

# figure for presentation
m_prev_fig2 <- plot(metsch_prev, dodge = 0.5, show.title = F) +
  scale_color_manual(values = diet_colors) +
  #ggtitle("Metsch prevalence by diet x host clone") +
  labs(x = "Host Clone", y = "Fungus Prevalence (%)") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_prev_fig2

ggsave("figures/MetschPrev_DietxClone.tiff", plot = m_prev_fig2, dpi = 600, width = 4, height = 3, units = "in", compression="lzw")



# calculate prevalence for each diet and clone
m_data_prev$Rep <- as.character(m_data_prev$Rep)

metsch_prev_sum <- m_data_prev %>%
  group_by(Diet, Clone) %>%
  summarise(Infected = sum(InfectionStatus), Tested = length(Rep),
            N  = length(Clearance_rel.Week1), 
            Mean_Clearance_rel = mean(Clearance_rel.Week1, na.rm = T),
            clearance.rel.sd   = sd(Clearance_rel.Week1, na.rm = T),
            clearance.rel.se   = clearance.rel.sd / sqrt(N),
            .groups = "rowwise") %>%
  mutate(Prevalence = unlist(epi.prev(Infected, Tested, method = "blaker", conf.level = 0.95, sp = 1, se = 0.95))[1],
         Prev_Lower = unlist(epi.prev(Infected, Tested, method = "blaker", conf.level = 0.95, sp = 1, se = 0.95))[2],
         Prev_Upper = unlist(epi.prev(Infected, Tested, method = "blaker", conf.level = 0.95, sp = 1, se = 0.95))[3])


m_prev_fig3 <- ggplot(metsch_prev_sum, aes(x = Clone, y= Prevalence)) +
  geom_point(aes(color = Diet), size = 2, position = position_dodge(width = 0.7)) +
  geom_errorbar(aes(ymin = Prev_Lower, ymax = Prev_Upper, color = Diet), width = 0.2, position = position_dodge(width = 0.7)) + 
  scale_color_manual(values = diet_colors) +
  labs(x = "Host Clone", y = "Fungus Prevalence (%)") +
  ylim(0, 100) +
  theme_classic() +
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_prev_fig3

# figures for presentation (calculated prevalence)
m_prev_fig3 <- ggplot(metsch_prev_sum, aes(x = Diet, y= Prevalence)) +
  geom_point(aes(color = Diet), size = 2) +
  geom_errorbar(aes(ymin = Prev_Lower, ymax = Prev_Upper, color = Diet), width = 0.2) + 
  scale_color_manual(values = diet_colors) +
  labs(x = "Diet Treatment", y = "Fungus Prevalence (%)") +
  ylim(0, 100) +
  facet_wrap(~Clone) +
  theme_classic() +
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_prev_fig3

ggsave("figures/MetschPrevCalcualtions_DietxClone.tiff", plot = m_prev_fig3, dpi = 600, width = 4, height = 3, units = "in", compression="lzw")


### Test of whether feeding rate impacts prevalence of infection
m_prev_feed_model <- glmer(Prevalence/100 ~ Mean_Clearance_rel * Clone + (1|Diet), weights = Tested, family = "binomial", data = metsch_prev_sum)
summary(m_prev_feed_model) 
Anova(m_prev_feed_model)
overdisp_fun(m_prev_feed_model)
library(rsq)
rsq.glmm(m_prev_feed_model)

m_prev_feed_fig <- ggplot(metsch_prev_sum, aes(x = Mean_Clearance_rel, y= Prevalence)) +
  geom_point(aes(color = Diet, shape = Clone), size = 2) +
  geom_errorbar(aes(ymin = Prev_Lower, ymax = Prev_Upper, color = Diet), width = 0.01) + 
  geom_errorbarh(aes(xmin = Mean_Clearance_rel-clearance.rel.se, xmax = Mean_Clearance_rel+clearance.rel.se, color = Diet), width = 0.01) + 
  geom_smooth(method = "lm", color = "black") +
  scale_color_manual(values = diet_colors) +
  labs(x = "Mean Relative Feeding Rate (mL per hr per mm)", y = "Fungus Prevalence (%)") +
  ylim(0, 100) +
  facet_wrap(~Clone) +
  theme_classic() +
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_prev_feed_fig
ggsave(here("figures/MetschPrevCalcualtions_RelFeedingRate3.tiff"), plot = m_prev_feed_fig, dpi = 600, width = 4.5, height = 3, units = "in", compression="lzw")


```


The separation in the data (categories with all zeros or all ones) is causing problems for this analysis in the M treatment. Clearly in both clones there are significant differences in the diet treatments with S having MUCH higher infection than all other diets. No significant differences between clones, nor is there an interaction between clone and diet (could remove the interaction term from the model). It seems that the presence of Microcystis in the diet seems to really protect against Metsch infection!  

In comparison to Kristel's 2019 Proc B paper, we similarly see a large decrease in infection prevalence when comparing the high quality Scenedesmus diet to the low quality Micorcystis diet. We don't see much of a change in infection prevalence between the Microcystis and the toxin spiked Microcosytis treatments in this experiment because prevalence is already so low from the microcystis diet alone.  

*NEED TO COME BACK TO FIX SEPARATION IN DATA*
I tried removing the M and M+ treatments (the treatments with data separation). That model runs better and allows for including the block random effect. There is a sig dif in diet, but not clone or diet x clone. Still has fairly large std error, probably because of the 100% infection in Std S treatment combo. Not sure there is really much to be done about that though...


## Spore Yield

### Comparison of Total Pasteuria spore yield based on diet and host clone.

```{r, model of Total Pasteuria spore yield by treatments}
# remove animals that died during exposure and remove uninfected treatments and remove animals with no spores detected
p_data_spores <- p_data %>% filter(!is.na(InfectionStatus) & Parasites == "Pasteuria" & total_spores > 0) 
#View(p_data_spores)

ptotsporemod <- glmmTMB(total_spores ~ Diet * Clone + (1|Block), family = poisson, data = p_data_spores)  # bad fit
ptotsporemod <- glmmTMB(total_spores ~ Diet * Clone + (1|Block), family = nbinom2(), data = p_data_spores) # better fit
ptotsporemod <- glmmTMB(total_spores ~ Diet * Clone + (1|Block), family = nbinom1(), data = p_data_spores)  # best fit
summary(ptotsporemod)
Anova(ptotsporemod)
AIC(ptotsporemod)
testDispersion(ptotsporemod)
testZeroInflation(ptotsporemod)
ptotspore_simResid <- simulateResiduals(fittedModel = ptotsporemod)
plot(ptotspore_simResid)  

ptotsporemod_contrasts <- emmeans(ptotsporemod, specs = pairwise ~ Diet | Clone, type = "response")
ptotsporemod_contrasts

range(p_data_spores$total_spores)
```

```{r, figure of Pasteuria total spore yield by treatment}
# Marginal effects from best model with Abundance on the x axis
past_totspores <- ggpredict(ptotsporemod, c("Clone", "Diet"))

p_totspore_fig <- plot(past_totspores, dodge = 0.4, add.data = T) +
  scale_color_manual(values = diet_colors) +
  ggtitle("Total Pasteuria Spore Yield by diet x host clone") +
  labs(x = "Host Clone", y = "Pasteuria Spore Yield (log scale)") +
  scale_y_log10(labels = scales::comma) +
  theme_classic()
p_totspore_fig

p_totspore_fig2 <- ggplot(p_data_spores, aes(x = Diet, y = total_spores)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge()) +
  geom_point(aes(shape=Diet), size=2, position=position_jitterdodge()) +
  facet_wrap(~Clone) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_shape_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  ylim(0,300000) +
  scale_y_log10(labels = scales::comma) +
  ggtitle("Total Pasteuria Spore Yield by diet x host clone") +
  labs(x = "Diet", y = "Pasteuria spore yield (log scaled)") +
  theme_classic()
p_totspore_fig2
```


There is a significant difference in spore yield based on clone, but not based on diet nor the interaction between the diet and clone. Model with the interaction included has a lower AIC, so left in the interaction. The range in spore yield in the M and M+ treatments for Mid37 seem much greater than for S and SM though. Overall, standard did not really get infected my Pasteuria much, though we did detect a few mature spores. Anecdotally, they did seem possibly degraded though...

**Question 1:** Is this data better represented by the ggeffects plot (top) or the boxplot (bottom)? It is possible that the standard error in the top plot is larger than it should be because the point has been back transformed from the log transformation, but I'm not sure that the standard error was as well based on one of the error messages...

**Question 2:** This data includes animals that I only saw one or two spores in the entire count (mostly in Standard treatments). I did not count those animals as infected in the prevalence data above because although I found a spore present, they did not appear infected in photos and the count was so low that I did not consider it a full infection. Should those very low spore counts be included in this analysis or should we have a cut off threshold for the spore yield that is needed to be included? 


### Comparison of Mature Pasteuria spore yield based on diet and host clone.

Note that there is one standard animal that had zero mature spores but did have one immature spore detected in the S treatment, which is included in this data set. 

```{r, model of Mature Pasteuria spore yield by treatments}
p_data_spores$mature_spores_log <- log(p_data_spores$mature_spores+1)
p_data_spores_mature <- filter(p_data_spores, mature_spores > 0) # remove the one sample without mature spores

pmaturesporemod <- glmmTMB(mature_spores ~ Diet * Clone + (1|Block), family = nbinom2(), data = p_data_spores_mature) # better fit
pmaturesporemod <- glmmTMB(mature_spores ~ Diet * Clone + (1|Block), family = nbinom1(), data = p_data_spores_mature)  # best fit of the residuals
summary(pmaturesporemod)
Anova(pmaturesporemod)
AIC(pmaturesporemod)
testDispersion(pmaturesporemod)
testZeroInflation(pmaturesporemod)
pmaturespore_simResid <- simulateResiduals(fittedModel = pmaturesporemod)
plot(pmaturespore_simResid)  

pmaturesporemod_contrasts <- emmeans(pmaturesporemod, specs = pairwise ~ Diet | Clone, type = "response")
pmaturesporemod_contrasts

range(p_data_spores$mature_spores)
```

```{r, figure of Pasteuria mature spore yield by treatment}
# Marginal effects from best model with Abundance on the x axis
past_maturespores <- ggpredict(pmaturesporemod, c("Clone", "Diet"))

p_maturespore_fig <- plot(past_maturespores, dodge = 0.4, add.data = T) +
  scale_color_manual(values = diet_colors) +
  ggtitle("Mature Pasteuria Spore Yield by diet x host clone") +
  labs(x = "Host Clone", y = "Pasteuria Spore Yield (log scale)") +
  scale_y_log10(labels = scales::comma) +
  theme_classic()
p_maturespore_fig

# figure for presentation
p_maturespore_fig3 <- plot(past_maturespores, dodge = 0.5, add.data = T, show.title = F) +
  scale_color_manual(values = diet_colors) +
  #ggtitle("Mature Pasteuria Spore Yield by diet x host clone") +
  labs(x = "Host Clone", y = "Mature Bacteria Spore Yield (log scale)") +
  scale_y_log10(labels = scales::comma, breaks = c(100, 1000, 10000,100000,1000000)) +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_maturespore_fig3

ggsave("figures/PastMatureSpores_DietxClone.tiff", plot = p_maturespore_fig3, dpi = 600, width = 4, height = 3, units = "in", compression="lzw")



p_maturespore_fig2 <- ggplot(p_data_spores_mature, aes(x = Diet, y = mature_spores)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge()) +
  geom_point(aes(shape=Diet), size=2, position=position_jitterdodge()) +
  facet_wrap(~Clone) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_shape_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  #ylim(0,1000000) +
  scale_y_log10(labels = scales::comma, breaks = c(100, 1000, 10000,100000,1000000)) +
  #ggtitle("Mature Pasteuria Spore Yield by diet x host clone") +
  labs(x = "Diet", y = "Pasteuria spore yield (log scaled)") +
  theme_classic()
p_maturespore_fig2
ggsave("figures/PastMatureSpores_DietxClone2.tiff", plot = p_maturespore_fig2, dpi = 600, width = 4, height = 3, units = "in", compression="lzw")

```


Results are similar to the total spore yield analyses. There is a sig difference between clones, but there is not a sig difference in mature spore yield among the different diet treatments. Mid37s are susceptible to Pasteuria, while Standards do not appear to be very susceptible.


```{r, model of Mature Past spore yield by microcystin concentration}
pmaturesporemod2 <- glmmTMB(mature_spores ~ microcystin.avg + Diet + Clone + (1|Block), family = nbinom2(), data = p_data_spores_mature)
pmaturesporemod2 <- glmmTMB(mature_spores ~ microcystin.avg + Diet + Clone + (1|Block), family = nbinom1(), data = p_data_spores_mature)  # lower AIC model
summary(pmaturesporemod2)
Anova(pmaturesporemod2)
AIC(pmaturesporemod2)
testDispersion(pmaturesporemod2)
testZeroInflation(pmaturesporemod2)
pmaturespore2_simResid <- simulateResiduals(fittedModel = pmaturesporemod2)
plot(pmaturespore2_simResid)  

# try model without M+ samples (outliers b/c so much higher than all other samples, see if there is a pattern )
p_data_spores_noM_tox <- filter(p_data_spores_mature, Diet != "M+")
pmaturesporemod3 <- glmmTMB(mature_spores ~ microcystin.avg * Diet + (1|Block), family = nbinom1(), data = p_data_spores_noM_tox)
summary(pmaturesporemod3)
Anova(pmaturesporemod3)
testDispersion(pmaturesporemod3)
testZeroInflation(pmaturesporemod3)
pmaturespore3_simResid <- simulateResiduals(fittedModel = pmaturesporemod3)
plot(pmaturespore3_simResid)  

# Remove other diets to only compare M and M+ diets  (only 8 data points...)
p_data_spores_M_tox <- filter(p_data_spores_mature, Diet == "M" | Diet == "M+")
pmaturesporemod4 <- glmmTMB(mature_spores ~ log(microcystin.avg+0.01) * Diet + (1|Block), family = nbinom1(), data = p_data_spores_M_tox)

summary(pmaturesporemod4)
Anova(pmaturesporemod4)
testDispersion(pmaturesporemod4)
testZeroInflation(pmaturesporemod4)
pmaturespore4_simResid <- simulateResiduals(fittedModel = pmaturesporemod4)
plot(pmaturespore4_simResid)  

```

```{r, figure of Mature Past spore yield by microcystin concentration}
# Marginal effects from best model with Abundance on the x axis
past_maturespores2 <- ggpredict(pmaturesporemod2, c("microcystin.avg", "Diet", "Clone"), ci = F)
plot(past_maturespores2, add.data = T)

p_maturespore_mc_fig <- plot(past_maturespores2, add.data = T) +
  scale_color_manual(values = diet_colors) +
  scale_fill_manual(values = diet_colors) +
  ggtitle("Pasteuria Spore Yield by microcstin + diet") +
  labs(x = "Microcystin conc (ug/L)", y = "log Bacteria Spore Yield") +
  scale_y_log10(labels = scales::comma, limits = c(1,1000000)) +
  theme_classic()
p_maturespore_mc_fig

mc_diets <- c("#006837", "#1D91C0")
p_maturespore_mc_fig2 <- ggplot(p_data_spores_M_tox, aes(x = microcystin.avg+1, y = mature_spores)) +
  geom_point(aes(color=Diet, shape = Clone), size=2) +
  geom_smooth(method = "lm", color = "black") +
  #facet_grid(Clone~Infection) +
  scale_color_discrete(limits = c("M", "M+")) +
  scale_color_manual(values = mc_diets) +
  scale_y_log10(labels = scales::comma) +
  scale_x_log10(breaks = c(1, 3, 5, 10, 20), labels = c(1, 3, 5, 10, 20)) +
  #xlim(0,20) +
  labs(x = "Average Microcystin Concentration (ug/L) log+1", y = "log Bacteria spore yield") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_maturespore_mc_fig2
ggsave("figures/PastMatureSpore_MicrocystinxClone.tiff", plot = p_maturespore_mc_fig2, dpi = 600, width = 6.5, height = 4, units = "in", compression="lzw")

```



### Comparison of Immature Pasteuria spore yield based on diet and host clone.

Most animals did not have any immature spores detected, so there will be a lot of zeros in this data set. I did not detect any cauliflower stage Pasteuria, so I did not run any models/figures for that parasite developmental stage.

```{r, model of Immature Pasteuria spore yield by treatments}
p_data_spores_immature <- filter(p_data_spores, immature_spores > 0) # remove the one sample without mature spores

pimmaturesporemod <- glmmTMB(immature_spores ~ Diet * Clone + (1|Block) + (1|Unique.code), family = poisson(), data = p_data_spores)  # overdispersed unless the unique code is added
pimmaturesporemod <- glmmTMB(immature_spores ~ Diet * Clone + (1|Block), family = nbinom2(), data = p_data_spores)  # better model to use! Lower AIC than poisson
#pimmaturesporemod <- glmmTMB(immature_spores ~ Diet * Clone + (1|Block), family = nbinom1(), data = p_data_spores)  # produces small eigenvalues and NAs in model output
summary(pimmaturesporemod)
Anova(pimmaturesporemod)
AIC(pimmaturesporemod)
testDispersion(pimmaturesporemod)
testZeroInflation(pimmaturesporemod)
pimmaturespore_simResid <- simulateResiduals(fittedModel = pimmaturesporemod)
plot(pimmaturespore_simResid)  

pimmaturesporemod_contrasts <- emmeans(pimmaturesporemod, specs = pairwise ~ Diet | Clone, type = "response")
pimmaturesporemod_contrasts


```

```{r, figure of Pasteuria immature spore yield by treatment}
# Marginal effects from best model with Abundance on the x axis
past_immaturespores <- ggpredict(pimmaturesporemod, c("Clone", "Diet"))

p_immaturespore_fig <- plot(past_immaturespores, dodge = 0.4, add.data = T) +
  scale_color_manual(values = diet_colors) +
  ggtitle("Immature Pasteuria Spore Yield by diet x host clone") +
  labs(x = "Host Clone", y = "Immature Pasteuria Spore Yield (log scale)") +
  scale_y_log10(labels = scales::comma) +
  theme_classic()
p_immaturespore_fig

p_immaturespore_fig2 <- ggplot(p_data_spores, aes(x = Diet, y = immature_spores+1)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge()) +
  geom_point(aes(shape=Diet), size=2, position=position_jitterdodge()) +
  facet_wrap(~Clone) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_shape_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  ylim(0,300000) +
  scale_y_log10(labels = scales::comma) +
  ggtitle("Immature Pasteuria Spore Yield by diet x host clone") +
  labs(x = "Diet", y = "Immature Pasteuria spore yield (log scaled)") +
  theme_classic()
p_immaturespore_fig2
```


Overall there are many fewer immature spores compared to mature spores in the infected animals. There is very wide variation in the number of immature spores in M and M+ treatments in Mid37s. May want to think about which data to acutally keep in this data set since there are a lot of zeros... When all zeros for immature spores are removed, then there are no significant main effects (diet, clone, diet*clone).


I did not find any spores at the cauliflower stage so that model was not run.


```{r, model and figure of pasteuria spore size}
p_data_spores_size <- filter(p_data_spores, !is.na(AvgSporeSize)) # remove animals where we did not measure spore size

# model of spore size based on diet x clone
sporesize_mod <- lm(AvgSporeSize ~ Diet * Clone, data = p_data_spores_size)
summary(sporesize_mod)
Anova(sporesize_mod)
AIC(sporesize_mod)
#plot(sporesize_mod)
qqnorm(resid(sporesize_mod))
qqline(resid(sporesize_mod)) # looks ok, not the best
ols_test_normality(sporesize_mod)  # shapiro-wilk is not significant, normal distribution should be fine
ols_test_breusch_pagan(sporesize_mod)
ols_plot_resid_fit(sporesize_mod)

# figure of spores size vs diet x clone
sporesize_plot <- ggplot(p_data_spores_size, aes(x = Diet, y = AvgSporeSize, fill = Diet)) +
  geom_boxplot() +
  geom_jitter(size = 2, alpha = 0.5, width = 0.2) +
  facet_wrap(~Clone) +
  scale_fill_manual(values = diet_colors) +
  #ggtitle("Pasteuria spore size based on diet") +
  labs(x = "Diet", y = bquote("Mean Bacteria Spore Area " ~ (mu *m^2))) +
  theme_classic()
sporesize_plot
ggsave(here("figures/Pasteuria_sporesize_dietxclone.tiff"), plot = sporesize_plot, dpi = 300, width = 5, height = 4, units = "in", compression="lzw")

  # very few replicates among the standard diet treatments, not a robust test including host clone


#  Spore size model with just diet
sporesize_mod2 <- lm(AvgSporeSize ~ Diet, data = p_data_spores_size)
summary(sporesize_mod2)
Anova(sporesize_mod2)
AIC(sporesize_mod2)
#plot(sporesize_mod)
qqnorm(resid(sporesize_mod2))
qqline(resid(sporesize_mod2)) # looks ok, not the best
ols_test_normality(sporesize_mod2)  # shapiro-wilk is not significant, normal distribution should be fine
ols_test_breusch_pagan(sporesize_mod2)
ols_plot_resid_fit(sporesize_mod2)

psporesize_contrasts <- emmeans(sporesize_mod2, specs = pairwise ~ Diet, type = "response")
psporesize_contrasts



# figure of spores size vs diet
sporesize_plot2 <- ggplot(p_data_spores_size, aes(x = Diet, y = AvgSporeSize, fill = Diet)) +
  geom_boxplot() +
  geom_jitter(size = 2, alpha = 0.5, width = 0.2) +
  scale_fill_manual(values = diet_colors) +
  labs(x = "Diet", y = bquote("Mean Bacteria Spore Area " ~ (mu *m^2))) +
  annotate(geom = "text", x = 3.5, y = 23, label = "p = 0.039") +
  annotate(geom = "text", x = c(1,2,3,4), y = c(24.5,21,21,21), label = c("a", "ab", "ab", "b")) +
  theme_classic()
sporesize_plot2
ggsave(here("figures/Pasteuria_sporesize_diet.tiff"), plot = sporesize_plot2, dpi = 300, width = 5, height = 4, units = "in", compression="lzw")

```





### Comparison of Total Metsch spore yield based on diet and host clone.


Most of the infected animals are in the S treatment, with only 3 in SM, and 1 in M+
```{r, model of Total Metsch spore yield by treatments}
# remove animals that died during exposure and remove uninfected treatments and remove animals with no spores detected
m_data_spores <- m_data %>% filter(!is.na(InfectionStatus) & Parasites == "Metsch" & total_spores > 0) 
#hist(m_data_spores$total_spores)

mtotsporemod <- glmmTMB(total_spores ~ Diet + Clone + (1|Block)  + (1|Unique.code), family = poisson, data = m_data_spores)  # overdispersed unless unique code is added, and even then still kind of overdispersed
mtotsporemod <- glmmTMB(total_spores ~ Diet + Clone + (1|Block), family = nbinom2(), data = m_data_spores)  # better than poisson
mtotsporemod <- glmmTMB(total_spores ~ Diet + Clone + (1|Block), family = nbinom1(), data = m_data_spores)  # lowest AIC and best fit with diagnostics
summary(mtotsporemod)
Anova(mtotsporemod)
AIC(mtotsporemod)
testDispersion(mtotsporemod)
testZeroInflation(mtotsporemod)
mtotspore_simResid <- simulateResiduals(fittedModel = mtotsporemod)
plot(mtotspore_simResid)

mtotsporemod_contrasts <- emmeans(mtotsporemod, specs = pairwise ~ Diet | Clone, type = "response")
mtotsporemod_contrasts

```

```{r, figure of Metsch total spore yield by treatment}
# set the color scheme for the Diet treatments for Metsch spore counts (missing the M treatment)
diet_colors2 <- c("#ADDD8E", "#41AB5D", "#1D91C0")

# Marginal effects from best model with Host clone on the x axis
metsch_totspores <- ggpredict(mtotsporemod, c("Clone", "Diet"))

m_totspore_fig <- plot(metsch_totspores, dodge = 0.4, add.data = T) +
  scale_color_manual(values = diet_colors) +
  ggtitle("Total Metsch Spore Yield by diet x host clone") +
  labs(x = "Host Clone", y = "Metsch Spore Yield (log scale)") +
  scale_y_log10(labels = scales::comma) +
  theme_classic()
m_totspore_fig

m_totspore_fig2 <- ggplot(m_data_spores, aes(x = Diet, y = total_spores)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width=0.7)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.7, jitter.width = 0.7), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  ylim(0,300000) +
  scale_y_log10(labels = scales::comma) +
  ggtitle("Total Metsch Spore Yield by diet x host clone") +
  labs(x = "Diet", y = "Metsch spore yield (log scaled)") +
  theme_classic()
m_totspore_fig2
```

There is not a significant difference in spore yield based on clone, but diet does have a significant difference (which is driven by the single Standard M spore count which is very low). The interaction between the diet and clone was not significant and oversaturated the model so I removed it. Model was struggling with lack of data in M and M+ diets for each clone. Need to think of a better way to model this data. Spore yield is very correlated with whether or not the animal got infected in the first place. Overall, S treatment had many more infected animals and on average higher than the other diet treatments but since there are so few samples in the other diet treatments it is hard to determine if that is a real difference. 

**NOTE** There is something not working quite right for the predicted figure with points and error bars because the data points for mid37 are shifted, and there are predicted values for M and M+ in mid37s when there aren't any data points for those treatments... USE THE BOXPLOT FIGURE!


### Comparison of Mature Metsch spore yield based on diet and host clone.


```{r, model of Mature Metsch spore yield by treatments}
m_data_maturespores <- m_data_spores %>% filter(mature_spores > 0) 
mmaturesporemod <- glmmTMB(mature_spores ~ Diet + Clone + (1|Block) + (1|Unique.code), family = poisson, data = m_data_maturespores)  # model is overdispersed unless unique.code random effect is included
mmaturesporemod <- glmmTMB(mature_spores ~ Diet + Clone + (1|Block), family = nbinom1(), data = m_data_maturespores)  # slightly higher AIC than nbinom2
mmaturesporemod <- glmmTMB(mature_spores ~ Diet + Clone + (1|Block), family = nbinom2(), data = m_data_maturespores)  # lower AIC than nbinom1, otherwise fit is similar
summary(mmaturesporemod) # not enough data to run the Diet x Clone interaction
Anova(mmaturesporemod)
AIC(mmaturesporemod)
testDispersion(mmaturesporemod)
testZeroInflation(mmaturesporemod)
mmaturespore_simResid <- simulateResiduals(fittedModel = mmaturesporemod)
plot(mmaturespore_simResid)

mmaturesporemod_contrasts <- emmeans(mmaturesporemod, specs = pairwise ~ Diet | Clone, type = "response")
mmaturesporemod_contrasts

range(m_data_spores$mature_spores)
```

```{r, figure of Metsch mature spore yield by treatment}
# Marginal effects from best model with Abundance on the x axis
metsch_maturespores <- ggpredict(mmaturesporemod, c("Clone", "Diet"))
#View(metsch_maturespores)

m_maturespore_fig <- plot(metsch_maturespores, dodge = 0.5, add.data = T, jitter = 0.05) +
  scale_color_manual(values = diet_colors) +
  ggtitle("Metsch Pasteuria Spore Yield by diet x host clone") +
  labs(x = "Host Clone", y = "Metsch Spore Yield (log scale)") +
  scale_y_log10(labels = scales::comma) +
  theme_classic()
m_maturespore_fig


# figure for presentation
m_maturespore_fig3 <- plot(metsch_maturespores, dodge = 0.5, add.data = T, show.title = F) +
  scale_color_manual(values = diet_colors) +
  #ggtitle("Mature Pasteuria Spore Yield by diet x host clone") +
  labs(x = "Host Clone", y = "Mature Fungus Spore Yield (log scale)") +
  scale_y_log10(labels = scales::comma) +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_maturespore_fig3

ggsave("figures/MetschMatureSpores_DietxClone.tiff", plot = m_maturespore_fig3, dpi = 600, width = 4, height = 3, units = "in", compression="lzw")



m_maturespore_fig2 <- ggplot(m_data_spores, aes(x = Diet, y = mature_spores+1)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width=0.7)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.7, jitter.width = 0.7), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  ylim(0,300000) +
  scale_y_log10(labels = scales::comma) +
  #ggtitle("Mature Metsch Spore Yield by diet x host clone") +
  labs(x = "Diet", y = "Mature Fungus Spore Yield (log+1 scaled)") +
  theme_classic()
m_maturespore_fig2

ggsave("figures/MetschMatureSpores_DietxClone2.tiff", plot = m_maturespore_fig2, dpi = 600, width = 4, height = 3, units = "in", compression="lzw")
```

Results are similar to the total spore yield analyses. There is not a sig difference between clones, but there is not a sig difference in mature spore yield among the different diet treatments.


```{r, model of Mature Metsch spore yield by microcystin concentration}
mmaturesporemod2 <- lmer(log(mature_spores) ~ microcystin.avg + Clone + Diet + (1|Block), data = m_data_maturespores)
mmaturesporemod2 <- lmer(log(mature_spores) ~ microcystin.avg + (1|Block), data = m_data_maturespores)
overdisp_fun(mmaturesporemod2)
summary(mmaturesporemod2)
Anova(mmaturesporemod2)
AIC(mmaturesporemod2)
qqnorm(resid(mmaturesporemod2))
qqline(resid(mmaturesporemod2))

# try model without M+ samples (outliers b/c so much higher than all other samples, see if there is a pattern )
m_data_spores_noM_tox <- filter(m_data_spores, Diet != "M+")
m_data_spores_noM_tox$mature_spores_log <- log(m_data_spores_noM_tox$mature_spores+1)
mmaturesporemod3 <- lmer(log(mature_spores+1) ~ microcystin.avg + Diet + (1|Block), data = m_data_spores_noM_tox)
mmaturesporemod3 <- lmer(mature_spores_log ~ microcystin.avg + Diet + (1|Block), data = m_data_spores_noM_tox)
summary(mmaturesporemod3)
Anova(mmaturesporemod3)
mmaturesporemod2 <- glmer(round(mature_spores) ~ microcystin.avg + Diet + (1|Block) + (1|Unique.code), family = poisson, data = m_data_spores)

# also try with M+ from extra treatment with microcystin avg added in (COMPARE ONLY M AND M+ TREATMENTS)
mmaturesporemod2 <- lmer(log(mature_spores+1) ~ microcystin.avg + Diet + (1|Block), data = m_data_spores)
summary(mmaturesporemod2)
Anova(mmaturesporemod3)
plot(mmaturesporemod2)


# Remove other diets to only compare M and M+ diets
m_data_spores_M_tox <- filter(m_data_maturespores, Diet == "M" | Diet == "M+")
mmaturesporemod4 <- lm(log(mature_spores) ~ log(microcystin.avg+1), data = m_data_spores_M_tox)
summary(mmaturesporemod4)
Anova(mmaturesporemod4)
qqnorm(resid(mmaturesporemod4))
qqline(resid(mmaturesporemod4))


```

```{r, figure of Mature Metsch spore yield by microcystin concentration}
# Marginal effects from best model with Abundance on the x axis
metsch_maturespores2 <- ggpredict(mmaturesporemod2, c("microcystin.avg"), ci = F)
plot(metsch_maturespores2, add.data = T)


m_maturespore_mc_fig <- plot(metsch_maturespores2, add.data = T) +
  scale_color_manual(values = diet_colors) +
  scale_fill_manual(values = diet_colors) +
  ggtitle("Metsch Pasteuria Spore Yield by microcstin + diet") +
  labs(x = "Microcystin conc (ug/L)", y = "log Metsch Spore Yield") +
  scale_y_log10() +
  scale_x_log10() +
  theme_classic()
m_maturespore_mc_fig
ggsave("figures/MetschMatureSpore_Microcystin_allData.tiff", plot = m_maturespore_mc_fig, dpi = 600, width = 6.5, height = 4, units = "in", compression="lzw")


mc_diets <- c("#006837", "#1D91C0")
m_maturespore_mc_fig2 <- ggplot(m_data_spores_M_tox, aes(x = microcystin.avg+1, y = mature_spores)) +
  geom_point(aes(color=Diet, shape = Clone), size=2) +
  geom_smooth(method = "lm", color = "black") +
  #facet_grid(Clone~Infection) +
  scale_color_discrete(limits = c("M", "M+")) +
  scale_color_manual(values = mc_diets) +
  scale_y_log10(labels = scales::comma) +
  scale_x_log10(breaks = c(1, 3, 5, 10, 20), labels = c(1, 3, 5, 10, 20)) +
  ylim(0,50000) +
  labs(x = "Average Microcystin Concentration (ug/L) log+1", y = "log Fungus spore yield") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_maturespore_mc_fig2
ggsave("figures/MetschMatureSpore_MicrocystinxClone.tiff", plot = m_maturespore_mc_fig2, dpi = 600, width = 6.5, height = 4, units = "in", compression="lzw")


```

Microcystin concentration does not have a significant impact on Metsch mature spore yield. There are too few infected animals in the M and M+ treatments to be able to test specifically for an effect of toxin alone with the diet controlled. I looked at microcystin and diet effects across both clones together (more power and little genotype differences), and did not find any sig effect of Microcystin concentration in the whole data set or in a subset of the data excluding the M+ treatments (only two so the microcystin concentrations are outliers compared to all others)


### Comparison of Immature Metsch spore yield based on diet and host clone.

```{r, model of Immature Metsch spore yield by treatments}
mimmaturesporemod <- lmer(log(immature_spores+1) ~ Diet + Clone + (1|Block), data = m_data_spores)
summary(mimmaturesporemod)
Anova(mimmaturesporemod)
AIC(mimmaturesporemod)

mimmaturesporemod_contrasts <- emmeans(mimmaturesporemod, specs = pairwise ~ Diet | Clone, type = "response")
mimmaturesporemod_contrasts

```

```{r, figure of Metsch immature spore yield by treatment}
# Marginal effects from best model with Abundance on the x axis
metsch_immaturespores <- ggpredict(mimmaturesporemod, c("Clone", "Diet"))

m_immaturespore_fig <- plot(metsch_immaturespores, dodge = 0.4, add.data = T) +
  scale_color_manual(values = diet_colors) +
  ggtitle("Immature Metsch Spore Yield by diet x host clone") +
  labs(x = "Host Clone", y = "Immature Metsch Spore Yield (log scale)") +
  scale_y_log10(labels = scales::comma) +
  theme_classic()
m_immaturespore_fig

m_immaturespore_fig2 <- ggplot(m_data_spores, aes(x = Diet, y = immature_spores+1)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width=0.7)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.7, jitter.width = 0.7), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  ylim(0,300000) +
  scale_y_log10(labels = scales::comma) +
  ggtitle("Immature Metsch Spore Yield by diet x host clone") +
  labs(x = "Diet", y = "Immature Metsch spore yield (log scaled)") +
  theme_classic()
m_immaturespore_fig2
```

Overall there are many fewer immature spores compared to mature spores in the infected animals.





### Comparison of Budding Metsch spore yield based on diet and host clone.

```{r, model of Budding Metsch spore yield by treatments}
mbudsporemod <- lmer(log(bud_spores+1) ~ Diet + Clone + (1|Block), data = m_data_spores)
summary(mbudsporemod)
Anova(mbudsporemod)
AIC(mbudsporemod)

mbudsporemod_contrasts <- emmeans(mbudsporemod, specs = pairwise ~ Diet | Clone, type = "response")
mbudsporemod_contrasts

```

```{r, figure of Metsch budding spore yield by treatment}
# Marginal effects from best model with Abundance on the x axis
metsch_budspores <- ggpredict(mbudsporemod, c("Clone", "Diet"))

m_budspore_fig <- plot(metsch_budspores, dodge = 0.4, add.data = T) +
  scale_color_manual(values = diet_colors) +
  ggtitle("Budding Metsch Spore Yield by diet x host clone") +
  labs(x = "Host Clone", y = "Budding Metsch Spore Yield (log scale)") +
  scale_y_log10(labels = scales::comma) +
  theme_classic()
m_budspore_fig

m_budspore_fig2 <- ggplot(m_data_spores, aes(x = Diet, y = bud_spores+1)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width=0.7)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.7, jitter.width = 0.7), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  ylim(0,300000) +
  scale_y_log10(labels = scales::comma) +
  ggtitle("Budding Metsch Spore Yield by diet x host clone") +
  labs(x = "Diet", y = "Budding Metsch spore yield (log scaled)") +
  theme_classic()
m_budspore_fig2
```

Overall there are many fewer immature spores compared to mature spores in the infected animals.



## Gut spore data for Metsch

The day after Metsch exposure, we looked at the number of Metsch spores that were embedded in or punctured through the gut wall of the daphnia, as well as the number of Metsch spores that were entirely in the haemoceol (body cavity) of the daphnia. We counted the number of hemocytes that were attached to either punctured or haemoceol spores that had passed partially or completely through the gut wall. 

### Total number of spores in the gut

```{r, model of Metsch total attacking gut spores by treatment}
m_data_gutspore <- m_data %>% filter(Block == 5 & Infection != "Uninfected") 
# only include animals in block 5 that were checked for gut spores and remove 3 animals that did not get exposed to parasites (STD SM, M, and M+ rep 20 for all, b/c ran out of spores for exposure)
hist(m_data_gutspore$TotalGutSpores)

mgutsporemod <- glm(TotalGutSpores ~ Diet * Clone, family = poisson, data = m_data_gutspore)
# Note: left off the block random effect because all these animals were in the same block 
summary(mgutsporemod)
Anova(mgutsporemod)
overdisp_fun(mgutsporemod)
AIC(mgutsporemod)

mgutsporemod2 <- glm(TotalGutSpores ~ Diet * Clone * length.um, family = poisson, data = m_data_gutspore)
# Note: left off the block random effect because all these animals were in the same block 
summary(mgutsporemod2)
Anova(mgutsporemod2)
overdisp_fun(mgutsporemod2)
AIC(mgutsporemod2)

mgutsporemod_contrasts <- emmeans(mgutsporemod, specs = pairwise ~ Diet | Clone, type = "response")
mgutsporemod_contrasts


mgutsporemod3 <- glm(TotalGutSpores ~ Clone * length.um, family = poisson, data = m_data_gutspore)
summary(mgutsporemod3)
Anova(mgutsporemod3)
```

```{r, figure of Metsch total gut spore by treatment}
# Marginal effects from best model with Abundance on the x axis
metsch_totgutspores <- ggpredict(mgutsporemod2, c("length.um", "Diet", "Clone"))

# figure with bodysize
m_totgutspores_fig <- plot(metsch_totgutspores, dodge = 0.4, add.data = T) +
  scale_color_manual(values = diet_colors) +
  scale_fill_manual(values = diet_colors) +
  ggtitle("Total Metsch spores in the gut by diet x host clone") +
  labs(x = "Host Length (um)", y = "Number Metsch spores attacking gut") +
  ylim(0,50) +
  theme_classic()
m_totgutspores_fig

# Marginal effects from best model with Abundance on the x axis
metsch_totgutspores1 <- ggpredict(mgutsporemod, c("Clone", "Diet"))

m_totgutspores_fig1 <- plot(metsch_totgutspores1, dodge = 0.4, add.data = T) +
  scale_color_manual(values = diet_colors) +
  ggtitle("Total Metsch spores in the gut by diet x host clone") +
  labs(x = "Host Clone", y = "Number Metsch spores attacking gut") +
  theme_classic()
m_totgutspores_fig1

m_totgutspores_fig2 <- ggplot(m_data_gutspore, aes(x = Diet, y = TotalGutSpores)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge()) +
  geom_point(aes(shape=Diet), size=2, position=position_jitterdodge()) +
  facet_wrap(~Clone) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_shape_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  ggtitle("Total Metsch spores in the gut by diet x host clone") +
  labs(x = "Diet", y = "Number Metsch spores attacking gut") +
  theme_classic()
m_totgutspores_fig2

# figure for presentation
m_totgutspores_fig3 <- ggplot(m_data_gutspore, aes(x = Diet, y = TotalGutSpores)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width=0.7)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.7, jitter.width = 0.7), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  labs(x = "Diet", y = "Number of Fungus Spores Attacking Gut") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_totgutspores_fig3

ggsave("figures/MetschGutSpores_DietxClone.tiff", plot = m_totgutspores_fig3, dpi = 600, width = 5, height = 4, units = "in", compression="lzw")

```

The effect of diet treatment and host clone were significant. Bodysize was not a significant predictor of the number of attacking metsch spores in the gut, and the model that included bodysize made the interaction between Diet*Clone insignificant (it was sig in the model without bodyzie included and the AIC is lower by ~9 in that model). There were substantially more Metsch spores attacking the guts of animals fed the high-quality Scenedesmus diet, and Standards tended to have more spores in their guts than Mid37s. This fits with our understanding that Standards tend to be more susceptible to Metsch than Mid37s. 

**Diets that included any Microcystis appear to really protect hosts from early exposure to attacking spores!**

I didn't run the models or figures for the different degrees of spore penetration into the gut (i.e. embedded, punctured, and haemoceol spores), but the pattern above is largely the same for the embedded and punctured spores. There were relatively few haemoceol spores overall, and all of the ones that I saw were in the S treatments. 

Tara Stewart Merrill looked at the proportion of attacking spores and a few other ways of calculating these spores counts, so we could potentially update these response variables to match what she previously did. (Note, I think that she included both embedded and punctured spores as "barrier spores" in her paper, so my "total gut spore" count is equivalent to her "Attacking spore" count)

### Hemocytes per punctured or haemoceol spore

We counted the number of hemocytes that were attached to metsch spores that had punctured or penetrated into the haemoceol of the daphnia. We then calculated the number of hemocytes per punctured or haemoceol spore by dividing the number of hemocytes counted by the total number of punctured and haemoceol spores ("TotalPunctSpores" column).

**Needed to filter data to remove animals where there were no punctured spores because then there would also not be any hemocytes counted, so there would be separation in the data.**

```{r, model of hemocytes per Metsch attacking gut spores by treatment}
m_data_hemocytes <- m_data_gutspore %>% filter(TotalGutSpores > 0) 
dim(m_data_hemocytes)
m_data_hemocytes$Unique.code <- as.factor(m_data_hemocytes$Unique.code)

hist(m_data_hemocytes$Hemocytes)
hist(m_data_hemocytes$HemocytesPerSpore)
# I'm not sure what is the best distribution to use for this data since it doesn't look normal but a poisson won't fit because the data are not integers...

# Number of hemocytes
mhemocytemod <- glmer(Hemocytes ~ Diet * Clone + TotalPunctSpores + (1|Unique.code), family = "poisson", data = m_data_hemocytes, control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
mhemocytemod <- glmer(Hemocytes ~ Diet * Clone + (1|Unique.code), family = "poisson", data = m_data_hemocytes, control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
summary(mhemocytemod)
Anova(mhemocytemod)
overdisp_fun(mhemocytemod) 
AIC(mhemocytemod)
# model is very overdispersed so I included a unique ID random effect to correct for that. The length term did not work well when included in the model, and the results for it were very messy, so I removed it to improve the model.

# Hemocytes per spore and including body size as a predictor
mhemocytemod2 <- lm(HemocytesPerSpore ~ Diet * Clone * length.um, data = m_data_hemocytes)
# Note: left off the block random effect because all these animals were in the same block 
summary(mhemocytemod2)
Anova(mhemocytemod2)
AIC(mhemocytemod2)

# Hemocytes per spore and NOT including body size as a predictor
mhemocytemod3 <- lm(HemocytesPerSpore ~ Diet * Clone, data = m_data_hemocytes)
# Note: left off the block random effect because all these animals were in the same block 
summary(mhemocytemod3)
Anova(mhemocytemod3)
AIC(mhemocytemod3) # AIC is lower without bodyzie

mhemocytemod_contrasts <- emmeans(mhemocytemod3, specs = pairwise ~ Diet | Clone, type = "response")
mhemocytemod_contrasts

```
```{r, figures of Metsch hemocytes per spore by treatment}
# Marginal effects 
metsch_hemocytes <- ggpredict(mhemocytemod, c("TotalPunctSpores", "Diet", "Clone"))

# figure with Total punctured spores
m_hemocytes_fig <- plot(metsch_hemocytes, dodge = 0.4, add.data = T) +
  scale_color_manual(values = diet_colors) +
  scale_fill_manual(values = diet_colors) +
  ggtitle("Recruited Hemocytes by # puncturing spores X diet x host clone") +
  labs(x = "Attacking Metsch spores", y = "Recruited Hemocytes") +
  ylim(0,55) +
  theme_classic()
m_hemocytes_fig

## Figure for presentation
m_hemocytes_fig2 <- ggplot(m_data_hemocytes, aes(x = Diet, y = Hemocytes)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width=0.7)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.7, jitter.width = 0.7), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_shape_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  #ggtitle("Hemocytes per attacking Metsch spore in the gut by diet x host clone") +
  labs(x = "Diet", y = "Recruited Hemocytes") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_hemocytes_fig2

ggsave("figures/Hemocytes_DietxClone.tiff", plot = m_hemocytes_fig2, dpi = 600, width = 5, height = 4, units = "in", compression="lzw")




# Marginal effects from best model with Abundance on the x axis
# metsch_hemocytes <- ggpredict(mhemocytemod, c("length.um", "Diet", "Clone"))
# 
# # figure with bodysize
# m_hemocytes_fig2 <- plot(metsch_hemocytes, dodge = 0.4, add.data = T) +
#   scale_color_manual(values = diet_colors) +
#   scale_fill_manual(values = diet_colors) +
#   ggtitle("Recruited Hemocytes by bodysize X diet x host clone") +
#   labs(x = "Length (um)", y = "Recruited Hemocytes") +
#   ylim(0,55) +
#   theme_classic()
# m_hemocytes_fig2



# Marginal effects
metsch_hemocytesperspore <- ggpredict(mhemocytemod3, c("Clone", "Diet"))

# figure with bodysize
m_hemocytesperspore_fig <- plot(metsch_hemocytesperspore, dodge = 0.4, add.data = T) +
  scale_color_manual(values = diet_colors) +
  ggtitle("Hemocytes per attacking Metsch spore in the gut by diet x host clone") +
  labs(x = "Host Clone", y = "Number of Hemocytes per Metsch spore attacking gut") +
  theme_classic()
m_hemocytesperspore_fig


m_hemocytesperspore_fig2 <- ggplot(m_data_hemocytes, aes(x = Diet, y = HemocytesPerSpore)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge()) +
  geom_point(aes(shape=Diet), size=2, position=position_jitterdodge()) +
  facet_wrap(~Clone) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_shape_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  ggtitle("Hemocytes per attacking Metsch spore in the gut by diet x host clone") +
  labs(x = "Diet", y = "Number of Hemocytes per Metsch spore attacking gut") +
  theme_classic()
m_hemocytesperspore_fig2


# figure for presentation
m_hemocytesperspore_fig3 <- ggplot(m_data_hemocytes, aes(x = Diet, y = HemocytesPerSpore)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width=0.7)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.7, jitter.width = 0.7), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  #ggtitle("Hemocytes per attacking Metsch spore in the gut by diet x host clone") +
  labs(x = "Diet", y = "Recruited Hemocytes per Attacking Fungus Spore") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_hemocytesperspore_fig3

ggsave("figures/HemocytesPerSpore_DietxClone.tiff", plot = m_hemocytesperspore_fig3, dpi = 600, width = 5, height = 4, units = "in", compression="lzw")


```


**Number of recruited hemoctyes model**
This model is having some problems, so I don't fully trust it yet...the GLM version is overdispered, so I added the unique code random effect to correct for the overdispersion. But when I do that, the model fails to converge if length is included. Even with length removed, it seems there is a bit of an issue because the figure can't produce the confidence intervals... 

In the GLMM with the random effect, there is only a significant positive correlation with the number of recruited hemoctyes. This matches what Tara previously found that the more attacking spores leads to more recruited hemoctyes.

In the GLM without the random effect there are significant interactions between Diet x Clone and Diet x length, and Total Punctured Spores attacking the gut has a significant positive correlation with the number of recruited hemoctyes. But this model is overdispersed, as discussed above, so may not be accurate.


**Recruited hemoctyes per spore model** 
There was no significant difference between diet or host clone in the number of recruited hemoctyes per attacking spore. Tested body legnth too, but it was not a significant predictor and the model AIC was improved by removing length from the model.


### Does number of attacking spores and/or number of recruited hemocytes predict terminal Metsch infection?


```{r, model of Metsch prevalence by treatments and attacking spores and recruited hemocytes}
m_data_inf <- m_data_gutspore %>% filter(!is.na(InfectionStatus)) 
dim(m_data_gutspore)
dim(m_data_inf)

mprevmod2 <- glm(InfectionStatus ~ Diet + Clone + TotalPunctSpores + Hemocytes, family = "binomial", data = m_data_inf)
summary(mprevmod2)  # try putting diet and/or clone as a random effect?
Anova(mprevmod2)
overdisp_fun(mprevmod2)

# Model does not perform well because there is too much separation in the data due to the effects of diet. 
# if Diet and clone are removed, there is still no sig effects of Total punctured spores or # hemocytes on infection...

mprevmod_contrasts <- emmeans(mprevmod2, specs = pairwise ~ Diet | Clone, type = "response")
mprevmod_contrasts

```

```{r, figures of Metsch prevaelence by diet x clone + attacking spores + hemocytes}
# Marginal effects from best model with Abundance on the x axis
metsch_inf <- ggpredict(mprevmod2, c("TotalPunctSpores", "Diet", "Clone"))

# figure with Total punctured spores
m_inf_fig <- plot(metsch_inf, dodge = 0.4, add.data = T, ci = F) +
  scale_color_manual(values = diet_colors) +
  scale_fill_manual(values = diet_colors) +
  ggtitle("Metsch prevalence by # attacking spores x diet x host clone") +
  labs(x = "Attacking Metsch spores", y = "Metsch Prevalence (%)") +
  theme_classic()
m_inf_fig

# Marginal effects from best model with Abundance on the x axis
metsch_inf2 <- ggpredict(mprevmod2, c("Hemocytes", "Diet", "Clone"))

# figure with Total punctured spores
m_inf_fig2 <- plot(metsch_inf2, dodge = 0.4, add.data = T, ci = F) +
  scale_color_manual(values = diet_colors) +
  scale_fill_manual(values = diet_colors) +
  ggtitle("Metsch prevalence by diet x host clone") +
  labs(x = "Recruited Hemocytes", y = "Metsch Prevalence (%)") +
  theme_classic()
m_inf_fig2
```

I think the data here may be too sparse to be used well. Unfortunately many of the animals that I checked for spores in the guts died the day after I looked at them under the scope, so I was not able to assess terminal infection status for those animals. And there was an unfortunate trend that the more of the animals that had spores in their guts tended to die more either because I took longer to count them on the scope, and/or they were more sensitive since they were experiencing an infection. 


## Fecundity 

### Total Feculity by treatment for Pasteuria experiment

Compare differences in total fecundity in the Pasteuria experiment based on infection status, diet, and host clone.

```{r, model of total fecundity for Pasteuria}
p_data_fecund <- p_data %>% filter(!is.na(Total.Babies)  & lifespan.days > 11)
hist(p_data$Total.Babies) 

# try poisson or zero inflated poisson
pfecundmod <- lmer(log(Total.Babies+1) ~ Diet * Infection * Clone + (1|Block), data = p_data_fecund)
summary(pfecundmod)
Anova(pfecundmod)
overdisp_fun(pfecundmod)
AIC(pfecundmod)
plot(pfecundmod)
qqnorm(resid(pfecundmod))
qqline(resid(pfecundmod))

pfecundmod_contrasts <- emmeans(pfecundmod, specs = pairwise ~ Diet + Infection | Clone, type = "response")
pfecundmod_contrasts

# test of microcystin effect on offspring production
p_data_fecund_toxintest <- filter(p_data_fecund, Diet == "M" | Diet == "M+")
pfecundmod2 <- lmer(log(Total.Babies+1) ~ log(microcystin.avg+1) * Infection * Clone + (1|Block), data = p_data_fecund_toxintest)
summary(pfecundmod2)
Anova(pfecundmod2)
overdisp_fun(pfecundmod2)
AIC(pfecundmod2)
plot(pfecundmod2)
qqnorm(resid(pfecundmod2))
qqline(resid(pfecundmod2))

```

```{r, total fecunity by treatment for past}
p_fecund_tot <- ggplot(p_data_fecund, aes(x = Infection, y = Total.Babies+1)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width=0.8)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.8, jitter.width = 0.25), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  scale_y_log10(labels = scales::comma) +
  ggtitle("Total Fecundity by infection status x diet x host clone for Past Expt") +
  labs(x = "Parasite Exposure", y = "Total Fecundity (log + 1 scaled)") +
  theme_classic()
p_fecund_tot

# figure for presentation
p_fecund_tot2 <- ggplot(p_data_fecund, aes(x = Infection, y = Total.Babies+1)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width=0.8)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.8, jitter.width = 0.25), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  scale_y_log10(labels = scales::comma) +
  #ggtitle("Total Fecundity by infection status x diet x host clone for Past Expt") +
  labs(x = "Parasite Exposure", y = "Total Fecundity (log + 1 scaled)") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_fecund_tot2

ggsave("figures/PastTotalFecundity_DietxClonexInfection.tiff", plot = p_fecund_tot2, dpi = 600, width = 6.5, height = 4, units = "in", compression="lzw")

mc_diets <- c("#006837", "#1D91C0")
p_fecund_tot3 <- ggplot(p_data_fecund_toxintest, aes(x = microcystin.avg+1, y = Total.Babies+1)) +
  geom_point(aes(color=Diet), size=2, alpha = 0.4) +
  geom_smooth(method = "lm", color = "black") +
  facet_grid(Clone~Infection) +
  scale_color_discrete(limits = c("M", "M+")) +
  scale_color_manual(values = mc_diets) +
  scale_y_log10(labels = scales::comma) +
  scale_x_log10() +
  #ggtitle("Total Fecundity by infection status x diet x host clone for Past Expt") +
  labs(x = "Average Microcystin Concentration (ug/L) log+1", y = "Total Fecundity (log + 1 scaled)") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_fecund_tot3
ggsave("figures/PastTotalFecundity_MicrocystinxClonexInfection.tiff", plot = p_fecund_tot3, dpi = 600, width = 6.5, height = 4, units = "in", compression="lzw")

```

The total fecundity model for Pasteuria is not performing perfectly with a poisson distribution, so I ended up log + 1 transforming total fecundity and running a LMM. This reduced changed whether the interactions are significant between diets, infection status, and host clones.  In this model there are significant effects of diet, infection status, and clone, but no interactions between each factor. 

Generally, decreasing resource quality leads to lower total fecundity. Pasteuria infected animals have fewer babies due to the parasite castration, though interestingly in the high quality diet some animals are able to have their first clutch before infection castrates them. And overall, Standards typically had more babies than Mid37s (though I think at a cost to their long-term survival...we will see below.)


I am not sure why the poisson distribution did not work...I thought that the poisson distribution should automatically log the response variable within the model to deal with count data... 


**Question:** What is the best way to account for Clone differences in the models? Do we care whether there are sig differences there? If not, then it may be better/easier to separate the data based on clone? 


### Total Feculity by treatment for Metsch experiment

Compare differences in total fecundity in the Metsch experiment based on infection status, diet, and host clone.

```{r, model of total fecundity for Metsch}
m_data_fecund <- m_data %>% filter(!is.na(Total.Babies) & lifespan.days > 11)
hist(m_data$Total.Babies) 
hist(log(m_data$Total.Babies+1)) 

mfecundmod <- lmer(log(Total.Babies+1) ~ Diet + Infection + Clone + Diet:Infection + Diet:Clone + Infection:Clone + (1|Block), data = m_data_fecund)
summary(mfecundmod)
Anova(mfecundmod) # model doesn't have enough power for the 3 way interaction
AIC(mfecundmod)
plot(mfecundmod)
qqnorm(resid(mfecundmod))
qqline(resid(mfecundmod))  # doesn't look great

mfecundmod_contrasts <- emmeans(mfecundmod, specs = pairwise ~ Diet + Infection | Clone, type = "response")
mfecundmod_contrasts


# test of microcystin effect on offspring production
m_data_fecund_toxintest <- filter(m_data_fecund, Diet == "M" | Diet == "M+")
mfecundmod2 <- lmer(log(Total.Babies+1) ~ log(microcystin.avg+1) + Infection + Clone + Infection:Clone + (1|Block), data = m_data_fecund_toxintest)
summary(mfecundmod2)
Anova(mfecundmod2)   # technically rank deficient to handle interactions, but infection x clone is sig anyways????
overdisp_fun(mfecundmod2)
AIC(mfecundmod2)
plot(mfecundmod2)
qqnorm(resid(mfecundmod2))
qqline(resid(mfecundmod2))
```

```{r, total fecunity by treatment for metsch}
m_fecund_tot2 <- ggplot(m_data_fecund, aes(x = Infection, y = Total.Babies+1)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width =0.8)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.8, jitter.width = 0.25), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  scale_y_log10(labels = scales::comma) +
  #ggtitle("Total Fecundity by infection status x diet x host clone for Metsch Expt") +
  labs(x = "Parasite Exposure", y = "Total Fecundity (log + 1 scaled)") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_fecund_tot2

ggsave("figures/MetschTotalFecundity_DietxClonexInfection.tiff", plot = m_fecund_tot2, dpi = 600, width = 6.5, height = 4, units = "in", compression="lzw")



mc_diets <- c("#006837", "#1D91C0")
m_fecund_tot3 <- ggplot(m_data_fecund_toxintest, aes(x = microcystin.avg+1, y = Total.Babies+1)) +
  geom_point(aes(color=Diet), size=2, alpha = 0.4) +
  geom_smooth(method = "lm", color = "black") +
  facet_grid(Clone~Infection) +
  scale_color_discrete(limits = c("M", "M+")) +
  scale_color_manual(values = mc_diets) +
  scale_y_log10(labels = scales::comma) +
  scale_x_log10() +
  ylim(0.9, 30) + 
  labs(x = "Average Microcystin Concentration (ug/L) log+1", y = "Total Fecundity (log + 1 scaled)") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_fecund_tot3
ggsave("figures/MetschTotalFecundity_MicrocystinxClonexInfection.tiff", plot = m_fecund_tot3, dpi = 600, width = 6.5, height = 4, units = "in", compression="lzw")



```

For the metsch experiment, all interactions between diet, infection status and clone are significant, except for the full 3-way interaction. 
In Mid37s, the S and uninfected treatment has higher total fecundity compared to most other treatments. Otherwise no significant differences among diet or infection status. In standards, S and SM uninfected have the highest total fecundity, which are significantly higher than S, SM and M exposed.  Overall, exposed animals seem to have very wide variability in their total fecundity compared to uninfected animals. This may suggest that there is some energetic cost to resisting infection (for some animals at least). Infected animals in S and SM treatments can still produce offspring despite infection.

**Question 1:** There are some differences in the sample size since we are doing it based off of the infection status (i.e. some treatments with very few infected or very few exposed depending on the prevalence in that treatment). Is there a better way to account for this? You can see where there are only a few points in the boxplots...

**Question 2:** Is the best way to visualize these difference by using letters on top of the different boxplots? Or adding the sig interaction effects in an annotation?


### Cummulative Fecunity over time

Need to do this still...

**Should this be average cumulative fecundity over time by treatment? Not sure how to best make this plot**

```{r, cumulative fecunity over time plot for past}
#fecund_time <- ggplot()

#fecund_time

```


### Little r by treatment for Pasteuria experiment

**Question:** Should I use r_mx or r_Fx? They are similar but slightly different versions. I have used r_mx for now but can easily change it.

```{r, little r figure for pasteuria experiment}
p_little_r <- ggplot(p_lifetable, aes(x = Infection, y = r_mx)) +
  geom_point(aes(color=Diet), size=2, position=position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = r_mx-Std.error_r_mx, ymax=r_mx+Std.error_r_mx, color=Diet), width = 0.2,  position=position_dodge(width=0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "lightgray") +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_color_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_color_manual(values = diet_colors) +
  ggtitle("Little r by infection status x diet x host clone for Past Expt") +
  labs(x = "Parasite Exposure", y = "r_mx") +
  theme_classic()
p_little_r

# figure for presentation
p_little_r2 <- ggplot(p_lifetable, aes(x = Infection, y = r_mx)) +
  geom_point(aes(color=Diet), size=2, position=position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = r_mx-Std.error_r_mx, ymax=r_mx+Std.error_r_mx, color=Diet), width = 0.2,  position=position_dodge(width=0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "lightgray") +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_color_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_color_manual(values = diet_colors) +
  #ggtitle("Little r by infection status x diet x host clone for Past Expt") +
  labs(x = "Parasite Exposure", y = bquote("Instantaneous Per Capita Pop. Growth Rate (r"~day^-1~")")) +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_little_r2

ggsave("figures/PastLittleR_DietxClonexInfection.tiff", plot = p_little_r2, dpi = 600, width = 6.5, height = 4, units = "in", compression="lzw")

```

High quality diets produce the largest little r instantaneous growth rates, and decreases with poorer quality diet. Exposure to Pasteuria, but not getting infected seems to reduce the little r for Mid37s a bit, but not for standards. Infection with Pasteuria results in castration, so those animals have very low little r's. Overall, there is not much of a difference in little r for M vs spiked toxin M treatments, except for exposed Mid37s, which have a very low little r with a wide standard error. This effect is not seen for Standards.


### Little r by treatment for Metsch experiment

```{r, little r figure for metsch experiment}
m_little_r <- ggplot(m_lifetable, aes(x = Infection, y = r_mx)) +
  geom_point(aes(color=Diet), size=2, position=position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = r_mx-Std.error_r_mx, ymax=r_mx+Std.error_r_mx, color=Diet), width = 0.2,  position=position_dodge(width=0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "lightgray") +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_color_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_color_manual(values = diet_colors) +
  ggtitle("Little r by infection status x diet x host clone for Metsch Expt") +
  labs(x = "Parasite Exposure", y = "r_mx") +
  theme_classic()
m_little_r

# figure for presentation
m_little_r2 <- ggplot(m_lifetable, aes(x = Infection, y = r_mx)) +
  geom_point(aes(color=Diet), size=2, position=position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = r_mx-Std.error_r_mx, ymax=r_mx+Std.error_r_mx, color=Diet), width = 0.2,  position=position_dodge(width=0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "lightgray") +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_color_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_color_manual(values = diet_colors) +
  #ggtitle("Little r by infection status x diet x host clone for Metsch Expt") +
  labs(x = "Parasite Exposure", y = bquote("Instantaneous Per Capita Pop. Growth Rate (r"~day^-1~")")) +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_little_r2

ggsave("figures/MetschLittleR_DietxClonexInfection.tiff", plot = m_little_r2, dpi = 600, width = 6.5, height = 4, units = "in", compression="lzw")

```

Metsch does not castrate it's host, so there is less of a dramatic effect on little r based on parasite infection. As diet quality decreases, little r decreases as well for both host clones and regardless of infection. In Standards, little r seems to be lower in animals exposed or infected with Metsch compared to uninfected animals, so maybe there is an energetic cost to resisting infection, and getting infected would definitely be costly for the animal. There doesn't seem to be this same difference in MId37s, except for in the high quality S diet treatment. Again there are no major differences between the Microcystis and toxin spiked Microcystis treatments.


Note that since the Metsch experiment was ended after 16 days post-exposure, the differences between the infected animals that died before the end of the experiment and the uninfected/exposed animals that were still alive at the end of the experiment would have become greater.



## Bodysize and Growth Rate

### Growth rate between week 1 and 2 for Pasteuria experiment

Compare differences in total fecundity in the Pasteuria experiment based on infection status, diet, and host clone.

```{r, model of growth rate for Pasteuria}
p_data_growth <- p_data %>% filter(!is.na(GrowthRate))
hist(p_data_growth$GrowthRate)  # wow normal data!! 

pgrowthmod <- lmer(GrowthRate ~ Diet * Infection * Clone + (1|Block), data = p_data_growth)
# removed block random effect because it was singular and caused a problem in the model
summary(pgrowthmod)
Anova(pgrowthmod)

pgrowthmod_contrasts <- emmeans(pgrowthmod, specs = pairwise ~ Diet + Infection | Clone, type = "response")
pgrowthmod_contrasts

```
```{r, growth rate by treatment for past}
p_growth <- ggplot(p_data_growth, aes(x = Infection, y = GrowthRate)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge()) +
  geom_point(aes(shape=Diet), size=2, position=position_jitterdodge()) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_shape_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  ggtitle("Growth Rate from Week 1 to 2 by infection status x diet x host clone for Past Expt") +
  labs(x = "Parasite Exposure", y = "Growth Rate (um per day)") +
  theme_classic()
p_growth

# figure for presentation
p_growth2 <- ggplot(p_data_growth, aes(x = Infection, y = GrowthRate)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width =0.9)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.9, jitter.width = 0.2), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  #ggtitle("Growth Rate from Week 1 to 2 by infection status x diet x host clone for Past Expt") +
  labs(x = "Parasite Exposure", y = bquote("Growth Rate ("~ mu* "m per day)")) +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_growth2

ggsave("figures/PastGrowthRate_DietxClonexInfection.tiff", plot = p_growth2, dpi = 600, width = 6.5, height = 4, units = "in", compression="lzw")

```
Since this is growth rate early on in the experiment, there would not have been signs of infection yet. There doesn't seem to be large differences between the infection status categories nor host clone. There are only significant differences consistently based on diet quality, where growth rate declines with poorer quality diet.


### Growth rate between week 1 and 2 for Metsch experiment

Compare differences in total fecundity in the Pasteuria experiment based on infection status, diet, and host clone.

```{r, model of growth rate for Metsch}
m_data_growth <- m_data %>% filter(!is.na(GrowthRate))
hist(m_data_growth$GrowthRate) # wow normal data!! 

mgrowthmod <- lmer(GrowthRate ~ Diet + Infection + Clone + Diet:Infection + Diet:Clone  + Infection:Clone +(1|Block), data = m_data_growth)
# Model had problems when all interactions and random effect included, but none of the interactions are significant
# so I removed the interactions and kept the random effect
summary(mgrowthmod)
Anova(mgrowthmod)
AIC(mgrowthmod)
plot(mgrowthmod)
qqnorm(resid(mgrowthmod))
qqline(resid(mgrowthmod))


mgrowthmod_contrasts <- emmeans(mgrowthmod, specs = pairwise ~ Diet + Infection | Clone, type = "response")
mgrowthmod_contrasts


# check if there is a sig interaction for infection x clone when only including uninfected and exposed animals
m_data_growth_noInf <- filter(m_data_growth, Infection != "Infected")
mgrowthmod2 <- lmer(GrowthRate ~ Diet + Infection + Clone + Diet:Infection + Diet:Clone  + Infection:Clone +(1|Block), data = m_data_growth_noInf)
summary(mgrowthmod2)
Anova(mgrowthmod2)
AIC(mgrowthmod2)
plot(mgrowthmod2)
qqnorm(resid(mgrowthmod2))
qqline(resid(mgrowthmod2))

mgrowthmod_contrasts2 <- emmeans(mgrowthmod2, specs = pairwise ~ Diet + Infection | Clone, type = "response")
mgrowthmod_contrasts2

```
Model AIC is a bit lower without including all the interactions

```{r, growth rate by treatment for Metsch}
m_growth <- ggplot(m_data_growth, aes(x = Infection, y = GrowthRate)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge()) +
  geom_point(aes(shape=Diet), size=2, position=position_jitterdodge()) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_shape_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  ggtitle("Growth Rate from Week 1 to 2 by infection status x diet x host clone for Metsch Expt") +
  labs(x = "Parasite Exposure", y = "Growth Rate (um per day)") +
  theme_classic()
m_growth

# figure for presentation
m_growth2 <- ggplot(m_data_growth, aes(x = Infection, y = GrowthRate)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width =0.9)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.9, jitter.width = 0.2), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  #ggtitle("Growth Rate from Week 1 to 2 by infection status x diet x host clone for Metsch Expt") +
  labs(x = "Parasite Exposure", y = bquote("Growth Rate ("~ mu* "m per day)")) +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_growth2

ggsave("figures/MetschGrowthRate_DietxClonexInfection.tiff", plot = m_growth2, dpi = 600, width = 6.5, height = 4, units = "in", compression="lzw")
```

There are significant differences for Diet, infection status, and host clone, but no sig interactions between any of those factors. As with the Pasteuria experiment, growth rate declined with poorer quality diets, Growth rate is lower in exposed or infected animals compared to uninfected animals, more so for the M and M+ treatments in Mid37s (less so for Standards).


## Bodysize over time for Pasteuria experiment
Need to do this still...

**Question 1:** Would these plots be useful or necessary compared to the growth rate ones from above? 

**Question 2:** if yes, then what is the best way to show this data over time? I was thinking averaging by treatment for each week of the experiment with std error bars...


## Bodysize over time for Metsch experiment
Need to do this still...


## Feeding Rate analyses

### Pasteuria feeding rate analyses

```{r, model of feeding rate for Past week 1 only}
p_data_feeding <- p_data %>% filter(!is.na(Clearance.Week1))
hist(p_data_feeding$Clearance.Week1) # wow normal data!!
hist(p_data_feeding$Clearance_rel.Week1) # wow normal data!! 

# Feeding rate (not bodysize controlled)
pfeedmod <- lmer(Clearance.Week1 ~ Diet * Infection * Clone +(1|Block), data = p_data_feeding)
summary(pfeedmod)
Anova(pfeedmod)
AIC(pfeedmod)
plot(pfeedmod)
qqnorm(resid(pfeedmod))
qqline(resid(pfeedmod))

# Relative Feeding rate (bodysize controlled)
pfeedmod2 <- lmer(Clearance_rel.Week1 ~ Diet * Infection * Clone +(1|Block), data = p_data_feeding)
summary(pfeedmod2)
Anova(pfeedmod2)
AIC(pfeedmod2)
plot(pfeedmod2)
qqnorm(resid(pfeedmod2))
qqline(resid(pfeedmod2))

pfeedmod_contrasts <- emmeans(pfeedmod2, specs = pairwise ~ Diet + Infection | Clone, type = "response")
pfeedmod_contrasts

pfeedmod_contrasts2 <- emmeans(pfeedmod2, specs = pairwise ~ Infection | Clone, type = "response")
pfeedmod_contrasts2

```
```{r, figure of past feeding rate week 1}
# Marginal effects
past_feed <- ggpredict(pfeedmod2, c("Infection", "Diet", "Clone"))
plot(past_feed)

# figure with bodysize
p_feeding_fig <- plot(past_feed, dodge = 0.6, add.data = T, show.title = F) +
  scale_color_manual(values = diet_colors) +
  #ggtitle("Relative Feeding Rate (mL per hr per mm)") +
  labs(x = "Parasite Exposure", y = "Relative Feeding Rate (mL per hr per mm)") +
  theme_classic()
p_feeding_fig
ggsave("figures/PastFeedingRate_DietxClonexInfection2.tiff", plot = p_feeding_fig, dpi = 600, width = 5, height = 4, units = "in", compression="lzw")


# figure for presentation
p_feeding2 <- ggplot(p_data_feeding, aes(x = Infection, y = Clearance_rel.Week1)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width =0.9)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.9, jitter.width = 0.2), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  #ggtitle("Growth Rate from Week 1 to 2 by infection status x diet x host clone for Metsch Expt") +
  labs(x = "Parasite Exposure", y = bquote("Relative Feeding Rate (mL per hr per mm)")) +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_feeding2

ggsave("figures/PastFeedingRate_DietxClonexInfection.tiff", plot = p_feeding2, dpi = 600, width = 5, height = 4, units = "in", compression="lzw")

# figure for Meg (week 1 feeding rate - NOT body size corrected)
p_feeding3 <- ggplot(p_data_feeding, aes(x = Infection, y = Clearance.Week1)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width =0.9)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.9, jitter.width = 0.2), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  labs(x = "Parasite Exposure", y = bquote("Feeding Rate (mL per hr)")) +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_feeding3

ggsave("figures/PastFeedingRate_DietxClonexInfection_Week1_NotBodysizeCorrected.tiff", plot = p_feeding3, dpi = 600, width = 5, height = 4, units = "in", compression="lzw")

```
 
 The relative body size feeding rate seems like the better model because ti controls for differences between clones that are likely just due to body size differences, while diet effects are sig in both models indicating that it high quality diet fed animals are eating more relative to their bodysize.



### Metsch feeding rate analyses

```{r, model of feeding rate for Metsch week 1 only}
m_data_feeding <- m_data %>% filter(!is.na(Clearance.Week1))
hist(m_data_feeding$Clearance.Week1) # wow normal data!! 
hist(m_data_feeding$Clearance_rel.Week1) # wow normal data!! 

mfeedmod <- lmer(Clearance.Week1 ~ Diet + Infection + Clone + Diet:Infection + Diet:Clone + Infection:Clone +(1|Block), data = m_data_feeding)
# removed the three-way interaction
summary(mfeedmod)
Anova(mfeedmod)
AIC(mfeedmod)


# Relative Feeding rate (bodysize controlled)
mfeedmod2 <- lmer(Clearance_rel.Week1 ~ Diet + Infection + Clone + Diet:Infection + Diet:Clone + Infection:Clone +(1|Block), data = m_data_feeding)
summary(mfeedmod2)
Anova(mfeedmod2) 
AIC(mfeedmod2)   # AIC is negative???
plot(mfeedmod2)
qqnorm(resid(mfeedmod2))
qqline(resid(mfeedmod2))

mfeedmod_contrasts <- emmeans(mfeedmod2, specs = pairwise ~ Diet + Infection | Clone, type = "response")
mfeedmod_contrasts

mfeedmod_contrasts2 <- emmeans(mfeedmod2, specs = pairwise ~ Infection | Clone, type = "response")
mfeedmod_contrasts2

```


```{r, figure of Metsch feeding rate week 1}
# Marginal effects
metsch_feed <- ggpredict(mfeedmod2, c("Infection", "Diet", "Clone"))
plot(metsch_feed)

# figure with bodysize
m_feeding_fig <- plot(metsch_feed, dodge = 0.6, add.data = T, show.title = F) +
  scale_color_manual(values = diet_colors) +
  #ggtitle("Relative Feeding Rate (mL per hr per mm)") +
  labs(x = "Parasite Exposure", y = "Relative Feeding Rate (mL per hr per mm)") +
  theme_classic()
m_feeding_fig
ggsave("figures/MetschFeedingRate_DietxClonexInfection2.tiff", plot = m_feeding_fig, dpi = 600, width = 5, height = 4, units = "in", compression="lzw")


# figure for presentation
m_feeding2 <- ggplot(m_data_feeding, aes(x = Infection, y = Clearance_rel.Week1)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width =0.9)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.9, jitter.width = 0.2), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  #ggtitle("Growth Rate from Week 1 to 2 by infection status x diet x host clone for Metsch Expt") +
  labs(x = "Parasite Exposure", y = bquote("Relative Feeding Rate (mL per hr per mm)")) +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_feeding2

ggsave("figures/MetschFeedingRate_DietxClonexInfection.tiff", plot = m_feeding2, dpi = 600, width = 5, height = 4, units = "in", compression="lzw")


# figure for Meg (week 1 feeding rate - NOT body size corrected)
m_feeding3 <- ggplot(m_data_feeding, aes(x = Infection, y = Clearance.Week1)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width =0.9)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.9, jitter.width = 0.2), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  labs(x = "Parasite Exposure", y = bquote("Feeding Rate (mL per hr)")) +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_feeding3

ggsave("figures/MetschFeedingRate_DietxClonexInfection_Week1_NotBodysizeCorrected.tiff", plot = m_feeding3, dpi = 600, width = 5, height = 4, units = "in", compression="lzw")
```



## Respiration Rate analyses

### Pasteuria respiration rate analyses

```{r, model of respiration rate for Past week 1 only and over time}
p_data_resp <- p_data %>% dplyr::filter(!is.na(metabolic.rate.Week1))
hist(as.numeric(p_data_resp$metabolic.rate.Week1)) # pretty close to normal, a tad right skewed
range(p_data_resp$metabolic.rate.Week1)

# Respiration rate during week 1 (exposure period) only
prespmod <- lmer(metabolic.rate.Week1 ~ Diet * Infection * Clone +(1|Block), data = p_data_resp)
summary(prespmod)
Anova(prespmod)
AIC(prespmod)
plot(prespmod)
qqnorm(resid(prespmod))
qqline(resid(prespmod))

prespmod_contrasts <- emmeans(prespmod, specs = pairwise ~ Diet + Infection | Clone, type = "response")
prespmod_contrasts


# Use long data set for time series data of respiration rate
p_longdata_resp <- p_longdata %>% dplyr::filter(!is.na(metabolic.rate))
hist(as.numeric(p_longdata_resp$metabolic.rate)) # a bit right skewed
range(p_longdata_resp$metabolic.rate)

# Respiration rate over whole experiment
prespmod2 <- lmer(metabolic.rate ~ Diet * Infection + Clone + Week + (1|Block), data = p_longdata_resp)
summary(prespmod2)
Anova(prespmod2)
AIC(prespmod2)
plot(prespmod2)
qqnorm(resid(prespmod2))
qqline(resid(prespmod2))

## NEED TO WORK ON THE CORRECT DISTRIBUTION FOR THIS MODEL
  # LOOKS LIKE A GAMMA DIST BUT HAS NEGATIVE VALUES (transformed by adding value to metabolic rate to make all positive, seems to have same outcome as linear model with a bit better fit, though not great still) family = Gamma("inverse")
  # COULD ALSO TRY THE LAPLACE DISTRIBUTION


```

```{r, figure of past respiration rate week 1 and over time}
# Marginal effects
past_resp <- ggpredict(prespmod, c("Infection", "Diet", "Clone"))
plot(past_resp)

# figure of respiration rate in week 1
p_resp_fig <- plot(past_resp, dodge = 0.6, add.data = F, show.title = F) +
  scale_color_manual(values = diet_colors) +
  #ggtitle("Respiration Rate (J/hr)") +
  labs(x = "Parasite Exposure", y = "Metabolic Rate (J/hr)") +
  theme_classic()
p_resp_fig
ggsave("figures/PastMetabolicRate_DietxClonexInfection2_Week1.tiff", plot = p_resp_fig, dpi = 600, width = 5, height = 4, units = "in", compression="lzw")


# Boxplot of week 1 metabolic rate
# figure for presentation
p_resp_fig2 <- ggplot(p_data_resp, aes(x = Infection, y = metabolic.rate.Week1)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width =0.9)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.9, jitter.width = 0.2), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  #ggtitle("Growth Rate from Week 1 to 2 by infection status x diet x host clone for Metsch Expt") +
  labs(x = "Parasite Exposure", y = bquote("Metabolic Rate (J/hr)")) +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_resp_fig2
ggsave("figures/PastMetabolicRate_DietxClonexInfection_Week1.tiff", plot = p_resp_fig2, dpi = 600, width = 5.25, height = 4, units = "in", compression="lzw")



# figures over time
## Plot of O2 saturation and metabolism over time by week
p_longdata_resp_sum <- p_longdata_resp %>%
  group_by(Diet, Infection, Clone, Week) %>%
  dplyr::summarize(N  = length(metabolic.rate),
            resp.mean = mean(metabolic.rate, na.rm = T),
            resp.sd   = sd(metabolic.rate, na.rm = T),
            resp.se   = resp.sd / sqrt(N)) %>%
  mutate(Treatment = paste0(Diet, "_", Infection, "_", Clone))
p_longdata_resp_sum$Week <- as.factor(p_longdata_resp_sum$Week)
p_longdata_resp_sum$Diet <- factor(p_longdata_resp_sum$Diet, levels = c("S", "SM", "M", "M+"))

plot_byWeek_resp_past <- ggplot(data = p_longdata_resp_sum, aes(x = Week, y = resp.mean, group = Treatment, shape = Diet)) +
  geom_hline(yintercept = 0, linetype = "dotted", colour = "gray") +
  geom_errorbar(aes(x=Week, ymin=resp.mean-resp.se, ymax=resp.mean+resp.se,color=Diet), width=0.2) + 
  geom_line(aes(color=Diet, group = Treatment), linewidth=1.5) +
  geom_point(aes(color=Diet), size=3, alpha = 0.8) +
  facet_grid(Clone~Infection) +
  ylim(-0.002, 0.01) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_color_manual(values = diet_colors) +
  scale_shape_manual(values=c(15,16,17,18)) +
  annotate("rect", xmin = 0.9, xmax = 1.1, ymin = -0.001, ymax = 0.01,
           alpha = .2,fill = "gray") +
  #ggtitle("Past Experiment Metabolic Rate") +
  labs(x = "Week of Experiment", y = "Metabolic Rate (J/hr)") +
  theme_classic()
plot_byWeek_resp_past
ggsave(here("figures/PastMetabolism_DietxCloneXInfection_byWeek.tiff"), plot = plot_byWeek_resp_past, dpi = 300, width = 7, height = 6, units = "in", compression="lzw")
```

During Week 1 (exposure period), only diet affects the metabolic rate, and there is no differences among clone or infection status (uninf, exposed, infected). 

In the model evaluating metabolic rate over time in the experiment, diet, clone, and week (positive) are all significant predictors of metabolic rate. There may be a sig 3 way interaction, but we don't have enough power to test that effectively. None of the two way interactions were significant. 

**NOTE** The model over time still needs some adjustment, the distribution is not normal and needs to be optimized still.


### Metsch respiration rate analyses


```{r, model of respiration rate for metsch week 1 only and over time}
m_data_resp <- m_data %>% dplyr::filter(!is.na(metabolic.rate.Week1))
hist(as.numeric(m_data_resp$metabolic.rate.Week1)) # More right skewed than I would like
range(m_data_resp$metabolic.rate.Week1)

# Respiration rate during week 1 (exposure period) only
mrespmod <- lmer(metabolic.rate.Week1 ~ Diet + Infection * Clone + Diet:Infection + Diet:Clone +(1|Block), data = m_data_resp)
summary(mrespmod)
Anova(mrespmod)
AIC(mrespmod)
plot(mrespmod)
qqnorm(resid(mrespmod)) # doesn't look too bad
qqline(resid(mrespmod))

mrespmod_contrasts <- emmeans(mrespmod, specs = pairwise ~ Diet + Infection | Clone, type = "response")
mrespmod_contrasts


# Use long data set for time series data of respiration rate
m_longdata_resp <- m_longdata %>% dplyr::filter(!is.na(metabolic.rate))
hist(as.numeric(m_longdata_resp$metabolic.rate)) # more normal than above, though a bit right skewed
range(m_longdata_resp$metabolic.rate)

# Respiration rate over whole experiment
mrespmod2 <- lmer(metabolic.rate ~ Diet + Infection + Clone + Week + Diet:Infection + Infection:Clone + (1|Block), data = m_longdata_resp)
summary(mrespmod2)
Anova(mrespmod2)
AIC(mrespmod2)
plot(mrespmod2)
qqnorm(resid(mrespmod2))  # doesn't look as good as I hoped
qqline(resid(mrespmod2))

## NEED TO WORK ON THE CORRECT DISTRIBUTION FOR THIS MODEL
  # LOOKS LIKE A GAMMA DIST BUT HAS NEGATIVE VALUES (transformed by adding value to metabolic rate to make all positive, seems to have same outcome as linear model with a bit better fit, though not great still) family = Gamma("inverse")
  # COULD ALSO TRY THE LAPLACE DISTRIBUTION


```

```{r, figure of metsch respiration rate week 1 and over time}
# Marginal effects
metsch_resp <- ggpredict(mrespmod, c("Infection", "Diet", "Clone"))
plot(metsch_resp)

# figure of respiration rate in week 1
m_resp_fig <- plot(metsch_resp, dodge = 0.6, add.data = F, show.title = F) +
  scale_color_manual(values = diet_colors) +
  #ggtitle("Respiration Rate (J/hr)") +
  labs(x = "Parasite Exposure", y = "Metabolic Rate (J/hr)") +
  theme_classic()
m_resp_fig
ggsave("figures/MetschMetabolicRate_DietxClonexInfection2_Week1.tiff", plot = m_resp_fig, dpi = 600, width = 5, height = 4, units = "in", compression="lzw")


# Boxplot of week 1 metabolic rate
# figure for presentation
m_resp_fig2 <- ggplot(m_data_resp, aes(x = Infection, y = metabolic.rate.Week1)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width =0.9)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.9, jitter.width = 0.2), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  labs(x = "Parasite Exposure", y = bquote("Metabolic Rate (J/hr)")) +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_resp_fig2
ggsave("figures/MetschMetabolicRate_DietxClonexInfection_Week1.tiff", plot = m_resp_fig2, dpi = 600, width = 5.25, height = 4, units = "in", compression="lzw")



# figures over time
## Plot of O2 saturation and metabolism over time by week
m_longdata_resp$Week <- as.factor(m_longdata_resp$Week)
m_longdata_resp$Diet <- factor(m_longdata_resp$Diet, levels = c("S", "SM", "M", "M+"))
m_longdata_resp_sum <- m_longdata_resp %>%
  ungroup() %>% dplyr::group_by(Diet, Infection, Clone, Week) %>%
  dplyr::summarize(N  = length(metabolic.rate),
            resp.mean = mean(metabolic.rate, na.rm = T),
            resp.sd   = sd(metabolic.rate, na.rm = T),
            resp.se   = resp.sd / sqrt(N), .groups = "keep") %>%
  mutate(Treatment = paste0(Diet, "_", Infection, "_", Clone))
m_longdata_resp_sum$Week <- as.factor(m_longdata_resp_sum$Week)
m_longdata_resp_sum$Diet <- factor(m_longdata_resp_sum$Diet, levels = c("S", "SM", "M", "M+"))

plot_byWeek_resp_metsch <- ggplot(data = m_longdata_resp_sum, aes(x = Week, y = resp.mean, group = Treatment, shape = Diet)) +
  geom_hline(yintercept = 0, linetype = "dotted", colour = "gray") +
  geom_errorbar(aes(x=Week, ymin=resp.mean-resp.se, ymax=resp.mean+resp.se,color=Diet), width=0.2) + 
  geom_line(aes(color=Diet, group = Treatment), linewidth=1.5) +
  geom_point(aes(color=Diet), size=3, alpha = 0.8) +
  facet_grid(Clone~Infection) +
  ylim(-0.002, 0.01) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_color_manual(values = diet_colors) +
  scale_shape_manual(values=c(15,16,17,18)) +
  annotate("rect", xmin = 0.9, xmax = 1.1, ymin = -0.001, ymax = 0.01,
           alpha = .2,fill = "gray") +
  #ggtitle("Metsch Experiment Metabolic Rate") +
  labs(x = "Week of Experiment", y = "Metabolic Rate (J/hr)") +
  theme_classic()
plot_byWeek_resp_metsch
ggsave(here("figures/MetschMetabolism_DietxCloneXInfection_byWeek.tiff"), plot = plot_byWeek_resp_metsch, dpi = 300, width = 7, height = 6, units = "in", compression="lzw")
```




During the parasite exposure period in week 1, metabolic rate is significantly different among diets and clones, but not infection status. 

Metabolic rate over the whole experiment differs significantly by diet, clone and week, but not infection status. Interaction were not significant, but also rank deficient to investigate the interactions rigorously.


## Survival analyses

### Pasteuria survival analyses

Need to remove some animals from data set? Which ones? Depending on whether we go with the Parasite treatment or the infection status (i.e. exposed vs infected vs uninfected) we may want to remove some categories where there are only one or two animals from the survival analysis.

Need to separate data based on host clone to make the plots easier to look at.

```{r, parse pasteuria data by host clone}
p_data$Diet2 = recode_factor(p_data$Diet, 'SM' = "50:50 SM", .default = levels(p_data$Diet2))
p_data$Diet2 <- factor(p_data$Diet2, levels = c("S", "50:50 SM", "M", "M+"))

p_data$SurvObj <- with(p_data, Surv(lifespan.days, Status))


p_data_std <- p_data %>% filter(Clone == "Standard") %>% mutate(Treatment_Combo = paste(Diet, Infection, sep = "_"))
p_data_mid <- p_data %>% filter(Clone == "Mid37") %>% mutate(Treatment_Combo = paste(Diet, Infection, sep = "_"))
```


**Standard survival in the Pasteuria experiment**

Kaplan-Meier models estimate the survival probability and the long-rank test. 

```{r, pasteuria experiment survival analyses for standards, fig.width=12}
p_data_std$SurvObj <- with(p_data_std, Surv(lifespan.days, Status))

# Kaplan-Meier estimator with "log-log" confidence interval
km.by.diet_parasite_std <- survfit(SurvObj ~ Diet + Parasites, data = p_data_std, conf.type = "log-log")
km.by.diet_parasite_std
km.by.diet_infstatus_std <- survfit(SurvObj ~ Diet + Infection, data = p_data_std, conf.type = "log-log")
km.by.diet_infstatus_std
km.by.diet_infstatus_std2 <- survfit(SurvObj ~ Diet2 + Infection, data = p_data_std, conf.type = "log-log")
km.by.diet_infstatus_std2

ggsurvplot(km.by.diet_parasite_std, data = p_data_std, pval = TRUE, xlab = "Days")
ggsurvplot(km.by.diet_infstatus_std, data = p_data_std, pval = TRUE, xlab = "Days")
ggsurvplot(km.by.diet_infstatus_std2, data = p_data_std, pval = TRUE, xlab = "Days")

```

Cox proportional hazards model calculates the risk of death and respective hazard ratios (HR). HR < 1 indicates an increased risk of death, and HR < 1 indicates a decreased risk of death.

```{r, pasteuria experiment cox prop hazards analyses for standards, fig.width=8}

# Cox proportional hazards model
cox.diet_parasite_std <- coxph(SurvObj ~ Diet + Parasites, data = p_data_std)
cox.diet_parasite_std
cox.diet_infstatus_std <- coxph(SurvObj ~ Diet + Infection, data = p_data_std)
summary(cox.diet_infstatus_std)
cox.diet_infstatus_std2 <- coxph(SurvObj ~ Diet2 + Infection, data = p_data_std)
summary(cox.diet_infstatus_std2)


cox.diet_infstatus_clone <- coxph(SurvObj ~ Diet2 + Infection + Clone, data = p_data)
summary(cox.diet_infstatus_clone)

# forest plot
ggforest(cox.diet_parasite_std, data = p_data_std)
ggforest(cox.diet_infstatus_std, data = p_data_std)
ggforest(cox.diet_infstatus_std2, data = p_data_std)

# forest plot for presentation
past_cox <- ggforest(cox.diet_infstatus_clone, data = p_data, cpositions = c(0.02, 0.15, 0.35))
past_cox
ggsave("figures/PastCoxHazard_DietxClonexInfection.tiff", plot = past_cox, dpi = 600, width = 6, height = 4, units = "in", compression="lzw")

# NOTE: the forest plot has a problem plotting the reference if it starts with the same letter as another factor in the same variable (e.g. S and SM), but the analysis runs correctly

```


**Mid37 survival in the Pasteuria experiment**

```{r, pasteuria experiment survival analyses for mid37s, fig.width=12}
p_data_mid$SurvObj <- with(p_data_mid, Surv(lifespan.days, Status))

# Kaplan-Meier estimator with "log-log" confidence interval
km.by.diet_parasite_mid <- survfit(SurvObj ~ Diet + Parasites, data = p_data_mid, conf.type = "log-log")
km.by.diet_infstatus_mid <- survfit(SurvObj ~ Diet + Infection, data = p_data_mid, conf.type = "log-log")

ggsurvplot(km.by.diet_parasite_mid, data = p_data_mid, pval = TRUE, xlab = "Days")
ggsurvplot(km.by.diet_infstatus_mid, data = p_data_mid, pval = TRUE, xlab = "Days")

```

```{r, pasteuria experiment cox prop hazards analyses for mid37s, fig.width=8}

# Cox proportional hazards model
cox.diet_parasite_mid <- coxph(SurvObj ~ Diet + Parasites, data = p_data_mid)
cox.diet_parasite_mid
cox.diet_infstatus_mid <- coxph(SurvObj ~ Diet + Infection, data = p_data_mid)
cox.diet_infstatus_mid
cox.diet_infstatus_mid2 <- coxph(SurvObj ~ Diet2 + Infection, data = p_data_mid)
cox.diet_infstatus_mid2

# forest plot
ggforest(cox.diet_parasite_mid, data = p_data_mid)
ggforest(cox.diet_infstatus_mid, data = p_data_mid)
```

May need to make a treatment category for Diet x parasite or Diet x Infection Status to be able to see the interaction between the treatments more clearly. Including an interaction term in the Cox model doesn't seem to be working when I try that...

Interestingly, pasteuria exposed animals suffered more mortality than then infected animals in Mid37s.


### Metsch survival analyses

```{r, parse metsch data by host clone}
m_data$Diet2 = recode_factor(m_data$Diet, 'SM' = "50:50 SM", .default = levels(m_data$Diet))
m_data$Diet2 <- factor(m_data$Diet2, levels = c("S", "50:50 SM", "M", "M+"))

m_data$SurvObj <- with(m_data, Surv(lifespan.days, Status))

m_data_std <- m_data %>% filter(Clone == "Standard") %>% mutate(Treatment_Combo = paste(Diet, Infection, sep = "_"))
m_data_mid <- m_data %>% filter(Clone == "Mid37") %>% mutate(Treatment_Combo = paste(Diet, Infection, sep = "_"))

```


**Standard survival in the Metsch experiment**

```{r, metsch experiment survival analyses for standards, fig.width=12}
m_data_std$SurvObj <- with(m_data_std, Surv(lifespan.days, Status))

# Kaplan-Meier estimator with "log-log" confidence interval
km.by.diet_parasite_std <- survfit(SurvObj ~ Diet + Parasites, data = m_data_std, conf.type = "log-log")
km.by.diet_infstatus_std <- survfit(SurvObj ~ Diet + Infection, data = m_data_std, conf.type = "log-log")

#pairwise survdiff
res <- pairwise_survdiff(Surv(lifespan.days, Status) ~ Diet + Infection,
     data = m_data_std)
res

ggsurvplot(km.by.diet_parasite_std, data = m_data_std, pval = TRUE, xlab = "Days")
ggsurvplot(km.by.diet_infstatus_std, data = m_data_std, pval = TRUE, xlab = "Days")

```

```{r, metsch experiment cox prop hazards analyses for standards, fig.width=8}

# Cox proportional hazards model
cox.m_diet_parasite_std <- coxph(SurvObj ~ Diet + Parasites, data = m_data_std)
cox.m_diet_parasite_std
cox.m_diet_infstatus_std <- coxph(SurvObj ~ Diet + Infection, data = m_data_std)
summary(cox.m_diet_infstatus_std)
cox.m_diet_infstatus_std2 <- coxph(SurvObj ~ Diet2 + Infection, data = m_data_std)
summary(cox.m_diet_infstatus_std2)

m_data$SurvObj <- with(m_data, Surv(lifespan.days, Status))
cox.m_diet_infstatus_clone <- coxph(SurvObj ~ Diet2 + Infection +Clone, data = m_data)
summary(cox.m_diet_infstatus_clone)

# forest plot
ggforest(cox.m_diet_parasite_std, data = m_data_std)
ggforest(cox.m_diet_infstatus_std, data = m_data_std)
ggforest(cox.m_diet_infstatus_std2, data = m_data_std)

# forest plot for presentation
metsch_cox <- ggforest(cox.m_diet_infstatus_clone, data = m_data, cpositions = c(0.02, 0.15, 0.35))
metsch_cox
ggsave("figures/MetschCoxHazard_DietxClonexInfection.tiff", plot = metsch_cox, dpi = 600, width = 5.5, height = 4, units = "in", compression="lzw")

```

Animals that were exposed to or infected with metsch experienced much greater risk of death! 

Not sure why both the uninfected and metsch treatments are considered reference in the first figure...


**Mid37 survival in the Metsch experiment**

```{r, metsch experiment survival analyses for mid37s, fig.width=12}
m_data_mid$SurvObj <- with(m_data_mid, Surv(lifespan.days, Status))

# Kaplan-Meier estimator with "log-log" confidence interval
km.by.diet_parasite_mid <- survfit(SurvObj ~ Diet + Parasites, data = m_data_mid, conf.type = "log-log")
km.by.diet_infstatus_mid <- survfit(SurvObj ~ Diet + Infection, data = m_data_mid, conf.type = "log-log")

ggsurvplot(km.by.diet_parasite_mid, data = m_data_mid, pval = TRUE, xlab = "Days")
ggsurvplot(km.by.diet_infstatus_mid, data = m_data_mid, pval = TRUE, xlab = "Days")

```

```{r, metsch experiment cox prop hazards analyses for mid37s, fig.width=8}

# Cox proportional hazards model
cox.m_diet_parasite_mid <- coxph(SurvObj ~ Diet + Parasites, data = m_data_mid)
cox.m_diet_parasite_mid
cox.m_diet_infstatus_mid <- coxph(SurvObj ~ Diet + Infection, data = m_data_mid)
cox.m_diet_infstatus_mid

# forest plot
ggforest(cox.m_diet_parasite_mid, data = p_data_mid)
ggforest(cox.m_diet_infstatus_mid, data = p_data_mid)

```

Animals that were exposed to or infected with metsch experienced much greater risk of death! 

Not sure why both the uninfected and metsch treatments are considered reference in the first figure...



### Lifespan figures

Pasteuria lifespan

```{r, pasteuria lifespan figure}
# figure for presentation
p_data_lifespan <- p_data %>% filter(Include_Lifespan == "Y")

p_lifespan <- ggplot(p_data_lifespan, aes(x = Infection, y = Lifespan)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width =0.9)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.9, jitter.width = 0.2), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  #ggtitle("Growth Rate from Week 1 to 2 by infection status x diet x host clone for Past Expt") +
  labs(x = "Parasite Exposure", y = "Lifespan") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_lifespan

ggsave("figures/PastLifespan_DietxClonexInfection.tiff", plot = p_lifespan, dpi = 600, width = 6.5, height = 4, units = "in", compression="lzw")



# does fecundity data explain differences in lifespan?
p_fecund_lifespan <- ggplot(p_data_lifespan, aes(x = Total.Babies+1, y = Lifespan)) +
  geom_point(aes(color=Diet), size=2, alpha = 0.6) +
  geom_smooth(method = "lm", color = "black") +
  facet_wrap(Clone~Infection) +
  scale_color_manual(values = diet_colors) +
  scale_x_log10() +
  labs(x = "Total Fecundity", y = "Lifespan") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_fecund_lifespan

# same plot as above but only for S treatment
p_data_lifespan_S <- filter(p_data_lifespan, Diet == "S")
p_fecund_lifespan_S <- ggplot(p_data_lifespan_S, aes(x = Total.Babies+1, y = Lifespan)) +
  geom_point(aes(color=Diet), size=2, alpha = 0.6) +
  geom_smooth(method = "lm", color = "black") +
  facet_wrap(Clone~Infection) +
  scale_color_manual(values = diet_colors) +
  scale_x_log10() +
  labs(x = "Total Fecundity", y = "Lifespan") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
p_fecund_lifespan_S

```



Metsch lifespan

```{r, metsch lifespan figure}
# figure for presentation
m_data_lifespan <- m_data %>% filter(Include_Lifespan == "Y")


m_lifespan <- ggplot(m_data_lifespan, aes(x = Infection, y = Lifespan)) +
  geom_boxplot(aes(fill=Diet),position=position_dodge(width =0.9)) +
  geom_point(aes(color=Diet), size=2, position=position_jitterdodge(dodge.width=0.9, jitter.width = 0.2), alpha = 0.4) +
  facet_wrap(~Clone) +
  scale_x_discrete(limits = c("Uninfected", "Exposed", "Infected")) +
  scale_fill_discrete(limits = c("S", "SM", "M", "M+")) +
  scale_fill_manual(values = diet_colors) +
  scale_color_manual(values = c(rep("black", 4))) +
  labs(x = "Parasite Exposure", y = "Lifespan") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_lifespan

ggsave("figures/MetschLifespan_DietxClonexInfection.tiff", plot = m_lifespan, dpi = 600, width = 6.5, height = 4, units = "in", compression="lzw")



# does fecundity data explain differences in lifespan?
m_fecund_lifespan <- ggplot(m_data_lifespan, aes(x = Total.Babies+1, y = Lifespan)) +
  geom_point(aes(color=Diet), size=2, alpha = 0.6) +
  geom_smooth(method = "lm", color = "black") +
  facet_wrap(Clone~Infection) +
  scale_color_manual(values = diet_colors) +
  scale_x_log10() +
  labs(x = "Total Fecundity", y = "Lifespan") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_fecund_lifespan

# same plot as above but only for S treatment
m_data_lifespan_S <- filter(m_data_lifespan, Diet == "S" | Diet == "SM")
m_fecund_lifespan_S <- ggplot(m_data_lifespan_S, aes(x = Total.Babies+1, y = Lifespan)) +
  geom_point(aes(color=Diet), size=2, alpha = 0.6) +
  geom_smooth(method = "lm", color = "black") +
  facet_wrap(Clone~Infection) +
  scale_color_manual(values = diet_colors) +
  scale_x_log10() +
  labs(x = "Total Fecundity", y = "Lifespan") +
  theme_classic() + 
  theme(axis.text = element_text(size=9, color = "black"), axis.title.y = element_text(size=11, color="black"), 
        axis.title.x = element_text(size=9, color="black"))
m_fecund_lifespan_S

```


